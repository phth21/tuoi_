<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Garden Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* PH√îNG CH·ªÆ & RESET */
        body { font-family: "Segoe UI", sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #333; }
        
        /* C√ÅC M√ÄN H√åNH */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #mainApp { display: none; width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box; }

        /* CARD GIAO DI·ªÜN */
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* N√öT B·∫§M C∆† B·∫¢N */
        .btn-simple { background: #e4e6eb; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; color: #050505; transition: 0.2s; }
        .btn-simple:hover { background: #d8dadf; }
        
        /* HI·ªÇN TH·ªä TR·∫†NG TH√ÅI KH√ÅCH (READ ONLY) */
        .viewer-disabled { 
            opacity: 0.6; 
            pointer-events: none; /* C·∫§M CLICK */
            filter: grayscale(100%); 
            position: relative;
        }
        /* Nh√£n d√°n cho ch·∫ø ƒë·ªô kh√°ch */
        .viewer-badge {
            position: absolute; top: -10px; right: -10px; background: #f39c12; color: white; 
            font-size: 10px; padding: 4px 8px; border-radius: 10px; font-weight: bold; z-index: 10;
        }

        /* V√íNG TR√íN ƒê·ªò ·∫®M */
        .soil-wrapper { text-align: center; margin: 20px 0; }
        .soil-circle { width: 180px; height: 180px; margin: 0 auto; border-radius: 50%; border: 12px solid #e4e6eb; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: border-color 0.3s; }
        .soil-value { font-size: 48px; font-weight: 700; color: #2ecc71; }
        .soil-label { font-size: 14px; color: #65676b; }
        .pump-status { font-size: 16px; font-weight: 600; color: #65676b; margin-top: 10px; }
        .warning-text { color: #e74c3c; font-weight: bold; min-height: 20px; font-size: 14px; margin-top: 5px; }

        /* GRID C·∫¢M BI·∫æN */
        .sensor-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px; }
        .sensor-box { background: #f7f8fa; padding: 15px; border-radius: 12px; text-align: center; }
        .sensor-val { font-size: 20px; font-weight: 700; color: #333; display: block; }
        .sensor-name { font-size: 13px; color: #65676b; }

        /* N√öT B∆†M */
        .control-area { margin-top: 20px; }
        .btn-pump { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .on { background: #2ecc71; }
        .off { background: #e74c3c; }

        /* AI INFO */
        .ai-box { background: #e8f5e9; padding: 15px; border-radius: 12px; border-left: 5px solid #2ecc71; }
        .ai-time { font-weight: bold; color: #d35400; }

        /* POPUP & TABLE */
        .popup { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; }
        .popup-inner { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; color: #65676b; padding: 8px; border-bottom: 1px solid #eee; }
        td { padding: 8px; border-bottom: 1px solid #eee; }

        /* N√∫t Start cho Admin */
        .btn-big { padding: 20px 40px; font-size: 18px; border: none; border-radius: 12px; background: #2ecc71; color: white; cursor: pointer; margin: 10px; width: 200px; }
    </style>
</head>
<body>

{% if role != 'VIEWER' %}
<div id="screenRegion" class="screen">
    <h2 style="margin-bottom:30px">Ch·ªçn Khu V·ª±c</h2>
    <button class="btn-big" onclick="emit('select_region', {region:'NORTH'})">Mi·ªÅn B·∫Øc</button>
    <button class="btn-big" style="background:#3498db" onclick="emit('select_region', {region:'CENTRAL'})">Mi·ªÅn Trung</button>
    <button class="btn-big" style="background:#e67e22" onclick="emit('select_region', {region:'SOUTH'})">Mi·ªÅn Nam</button>
</div>

<div id="screenMode" class="screen" style="display:none">
    <h2 style="margin-bottom:30px">Ch·ªçn Ch·∫ø ƒê·ªô</h2>
    <button class="btn-big" onclick="emit('enter_mode', {mode:'AUTO'})">ü§ñ T·ª± ƒê·ªông (AI)</button>
    <button class="btn-big" style="background:#95a5a6" onclick="emit('enter_mode', {mode:'MANUAL'})">üéÆ Th·ªß C√¥ng</button>
</div>
{% endif %}

<div id="mainApp">
    <div class="card">
        <div class="header-row">
            <div id="mqttStatus" style="width:10px; height:10px; border-radius:50%; background:#ccc;"></div>
            <div>
                {% if role == 'VIEWER' %}
                    <span style="background:#ffeaa7; color:#d35400; padding:6px 12px; border-radius:20px; font-weight:bold; font-size:12px;">üëÅÔ∏è KH√ÅCH XEM</span>
                {% else %}
                    <button class="btn-simple" onclick="exit()">Menu</button>
                {% endif %}
                <a href="/logout" class="btn-simple" style="color:red; margin-left:5px">Tho√°t</a>
            </div>
        </div>

        <div class="header-row">
            <div style="font-size:18px; font-weight:700;">üìç <span id="loc">ƒêang k·∫øt n·ªëi...</span></div>
            {% if role != 'VIEWER' %}
            <div>
                <button class="btn-simple" onclick="getRealGPS()">üéØ</button>
                <button class="btn-simple" onclick="openCityPopup()">List</button>
            </div>
            {% endif %}
        </div>

        <div class="soil-wrapper">
            <div class="soil-circle" id="soilBox">
                <span class="soil-value" id="soil">--</span>
                <span class="soil-label">% ƒê·ªò ·∫®M</span>
            </div>
            <div class="warning-text" id="warn"></div>
            <div class="pump-status" id="pumpSt">TR·∫†NG TH√ÅI: --</div>
        </div>

        <div class="sensor-row">
            <div class="sensor-box"><span class="sensor-val" id="temp">--¬∞</span><span class="sensor-name">Nhi·ªát ƒë·ªô</span></div>
            <div class="sensor-box"><span class="sensor-val" id="hum">--%</span><span class="sensor-name">ƒê·ªô ·∫©m KK</span></div>
            <div class="sensor-box"><span class="sensor-val" id="rain">--</span><span class="sensor-name">M∆∞a</span></div>
        </div>

        <div class="control-area">
            <div id="panelAuto" style="display:none; margin-bottom:15px">
                <div class="ai-box">
                    <h4 style="margin:0; color:#27ae60">ü§ñ AI Gemini Auto</h4>
                    <p style="margin:5px 0; font-size:14px">K·∫ø ho·∫°ch: <span class="ai-time" id="aiTime">...</span></p>
                    <p style="margin:0; font-style:italic; font-size:13px; color:#555">"<span id="aiReason">...</span>"</p>
                </div>
            </div>

            <div id="panelManual" class="{% if role == 'VIEWER' %}viewer-disabled{% endif %}">
                {% if role == 'VIEWER' %}<div class="viewer-badge">CH·ªà XEM</div>{% endif %}
                <button id="btnPumpOn" class="btn-pump on" onclick="pump(true)">B·∫¨T B∆†M T∆Ø·ªöI</button>
                <button id="btnPumpOff" class="btn-pump off" onclick="pump(false)" style="display:none">T·∫ÆT M√ÅY B∆†M</button>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <canvas id="myChart" height="100"></canvas>
            <button class="btn-simple" style="width:100%; margin-top:15px; background:#f0f2f5" onclick="openHistory()">Xem L·ªãch s·ª≠ ho·∫°t ƒë·ªông</button>
        </div>
    </div>
</div>

{% if role != 'VIEWER' %}
<div id="cityPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-inner">
        <h3>Ch·ªçn Th√†nh Ph·ªë</h3>
        <div id="cityList" style="display:grid; gap:10px;"></div>
        <button class="btn-simple" style="width:100%; margin-top:15px" onclick="document.getElementById('cityPopup').style.display='none'">ƒê√≥ng</button>
    </div>
</div>
{% endif %}

<div id="historyPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-inner" style="max-width:600px">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px">
            <h3>Nh·∫≠t K√Ω</h3>
            <input type="date" id="dateInput" onchange="loadHistory()" style="padding:5px; border:1px solid #ddd; border-radius:5px">
        </div>
        <div style="overflow-x:auto">
            <table><thead><tr><th>Gi·ªù</th><th>H√†nh ƒë·ªông</th><th>Chi ti·∫øt</th></tr></thead><tbody id="histBody"></tbody></table>
        </div>
        <button class="btn-simple" style="width:100%; margin-top:15px" onclick="document.getElementById('historyPopup').style.display='none'">ƒê√≥ng</button>
    </div>
</div>

<script>
    const BROKER_URL = 'wss://broker.hivemq.com:8884/mqtt';
    const PREFIX = "thaocute_smartgarden/";
    const USER_ROLE = "{{ role }}"; 
    
    const client = mqtt.connect(BROKER_URL, { keepalive: 60, clientId: 'Web_' + Math.random().toString(16).substr(2, 8), clean: true });
    
    // Chart
    let myChart = new Chart(document.getElementById('myChart'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: '%', data: [], borderColor: '#2ecc71', borderWidth: 2, tension: 0.4, fill: false, pointRadius: 0 }] },
        options: { scales: { y: { beginAtZero: true, max: 100, display: false }, x: { display: false } }, plugins: { legend: { display: false } } }
    });

    const CITIES = { 'NORTH': ["H√† N·ªôi", "H·∫£i Ph√≤ng", "L√†o Cai"], 'CENTRAL': ["ƒê√† N·∫µng", "Hu·∫ø", "Nha Trang"], 'SOUTH': ["TP.HCM", "C·∫ßn Th∆°", "C√† Mau"] };
    let currentRegion = 'NORTH';

    // --- LOGIC HI·ªÇN TH·ªä QUAN TR·ªåNG ---
    function checkDisplay(step) {
        if (USER_ROLE === 'VIEWER') {
            // KH√ÅCH: Lu√¥n hi·ªán Dashboard, ·∫©n setup
            document.getElementById('mainApp').style.display = 'block';
            return;
        }
        // ADMIN: Hi·ªán theo b∆∞·ªõc
        document.getElementById('screenRegion').style.display = (step === 0) ? 'flex' : 'none';
        document.getElementById('screenMode').style.display   = (step === 1) ? 'flex' : 'none';
        document.getElementById('mainApp').style.display      = (step === 2) ? 'block' : 'none';
    }

    // M·∫∑c ƒë·ªãnh g·ªçi lu√¥n khi t·∫£i trang ƒë·ªÉ Kh√°ch kh√¥ng b·ªã m√†n h√¨nh tr·∫Øng
    checkDisplay(0); 

    client.on('connect', () => {
        console.log("Connected");
        document.getElementById('mqttStatus').style.background = "#2ecc71";
        client.subscribe(PREFIX + 'update');
    });

    client.on('message', (topic, msg) => {
        if (topic === PREFIX + 'update') updateUI(JSON.parse(msg.toString()));
    });

    function updateUI(d) {
        if (!d) return;
        currentRegion = d.region;
        checkDisplay(d.step);

        // Update Text
        document.getElementById('loc').innerText = d.location;
        document.getElementById('temp').innerText = d.temp + "¬∞";
        document.getElementById('hum').innerText = d.humidity + "%";
        document.getElementById('rain').innerText = d.rain;
        document.getElementById('soil').innerText = d.soil;
        document.getElementById('warn').innerText = d.warning;

        // Soil Circle Color
        const soilBox = document.getElementById('soilBox');
        soilBox.style.borderColor = (parseInt(d.soil) < 26) ? "#e74c3c" : "#2ecc71";

        // Pump Status & Buttons
        const pst = document.getElementById('pumpSt');
        if (d.pump) { 
            pst.innerText = "üí¶ ƒêANG B∆†M N∆Ø·ªöC..."; pst.style.color = "#2980b9";
            document.getElementById('btnPumpOn').style.display = 'none';
            document.getElementById('btnPumpOff').style.display = 'flex';
        } else { 
            pst.innerText = "TR·∫†NG TH√ÅI: T·∫ÆT"; pst.style.color = "#7f8c8d";
            document.getElementById('btnPumpOn').style.display = 'flex';
            document.getElementById('btnPumpOff').style.display = 'none';
        }

        // Logic ·∫©n hi·ªán Panel: N·∫øu Mode = Auto th√¨ hi·ªán Auto, c√≤n l·∫°i (Manual ho·∫∑c None) th√¨ hi·ªán Manual
        // N·∫øu l√† Kh√°ch -> V·∫´n th·∫•y Manual Panel (nh∆∞ng b·ªã disabled b·ªüi CSS)
        if (d.mode === 'AUTO') {
            document.getElementById('panelAuto').style.display = 'block';
            document.getElementById('panelManual').style.display = 'none';
            document.getElementById('aiTime').innerText = d.ai_timing;
            document.getElementById('aiReason').innerText = d.ai_reason;
        } else {
            document.getElementById('panelAuto').style.display = 'none';
            document.getElementById('panelManual').style.display = 'block';
        }

        // Chart Update
        if (myChart.data.labels.length > 20) { myChart.data.labels.shift(); myChart.data.datasets[0].data.shift(); }
        myChart.data.labels.push(""); myChart.data.datasets[0].data.push(d.soil);
        myChart.update();
    }

    function emit(ev, d) { 
        if(USER_ROLE === 'VIEWER') return alert("Kh√°ch ch·ªâ ƒë∆∞·ª£c xem!");
        client.publish(PREFIX + 'events', JSON.stringify({event: ev, data: d})); 
    }

    function pump(st) { emit('user_control', {pump: st}); }
    function exit() { if(confirm("V·ªÅ menu ch√≠nh?")) emit('exit_dashboard', {}); }
    
    // C√°c h√†m Admin (ƒë√£ ·∫©n n√∫t v·ªõi kh√°ch, nh∆∞ng gi·ªØ code ƒë·ªÉ JS kh√¥ng l·ªói)
    function getRealGPS() {
        if (!navigator.geolocation) return alert("L·ªói");
        document.getElementById('loc').innerText = "...";
        navigator.geolocation.getCurrentPosition((p) => emit('set_gps', { lat: p.coords.latitude, lon: p.coords.longitude }));
    }
    function openCityPopup() {
        if(USER_ROLE==='VIEWER') return;
        const list = document.getElementById('cityList'); list.innerHTML = "";
        (CITIES[currentRegion] || []).forEach(c => {
            let btn = document.createElement('button'); btn.className = "btn-simple"; btn.innerText = c;
            btn.onclick = () => { emit('set_city', {city: c}); document.getElementById('cityPopup').style.display='none'; };
            list.appendChild(btn);
        });
        document.getElementById('cityPopup').style.display = 'flex';
    }

    // H√†m L·ªãch s·ª≠ (Ai c≈©ng d√πng ƒë∆∞·ª£c)
    function openHistory() {
        document.getElementById('historyPopup').style.display = 'flex';
        document.getElementById('dateInput').valueAsDate = new Date();
        loadHistory();
    }
    function loadHistory() {
        fetch('/api/history?date=' + document.getElementById('dateInput').value)
            .then(res => res.json()).then(data => {
                const tbody = document.getElementById('histBody'); tbody.innerHTML = "";
                if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="3">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'; return; }
                data.forEach(i => {
                    let color = i.action.includes('ON') ? '#27ae60' : '#2980b9';
                    tbody.innerHTML += `<tr><td>${i.time}</td><td style="color:${color};font-weight:bold">${i.action}</td><td>${i.detail}</td></tr>`;
                });
            });
    }
</script>
</body>
</html>
