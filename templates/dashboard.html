<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Garden Pro</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary:#2e7d32; --bg-app:#e8f5e9; --danger:#d32f2f; }
        body { margin:0; font-family:'Be Vietnam Pro', sans-serif; background:var(--bg-app); color:#333; display:flex; justify-content:center; }
        
        /* C·∫•u tr√∫c m√†n h√¨nh */
        .screen { position:fixed; width:100%; height:100%; background:#e8f5e9; z-index:99; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; transition: opacity 0.3s; }
        #mainApp { width:100%; max-width:480px; padding:15px; box-sizing:border-box; display:none; }
        
        /* Card v√† N√∫t */
        .card { background:white; border-radius:20px; padding:20px; box-shadow:0 5px 20px rgba(0,0,0,0.05); margin-bottom:15px; position:relative; }
        .btn-big { width:80%; max-width:300px; padding:18px; margin:10px 0; border:none; border-radius:12px; background:white; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.1); cursor:pointer; font-size:16px; transition:0.2s; }
        .btn-big:active { transform:scale(0.95); background:#f1f8e9; }
        .btn-pump { width:100%; padding:15px; border-radius:12px; border:none; color:white; font-weight:bold; cursor:pointer; margin-top:15px; font-size:16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* ƒê·ªìng h·ªì ƒë·ªô ·∫©m */
        .soil-circle { width:150px; height:150px; border-radius:50%; border:12px solid #f1f8e9; margin:10px auto; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.5s; position: relative; }
        .soil-val { font-size:42px; font-weight:800; color:var(--primary); }
        
        /* Grid th√¥ng s·ªë */
        .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:20px; }
        .sensor-box { background:#f9fbe7; padding:12px 5px; border-radius:12px; text-align:center; font-size:13px; color:#555; }
        .sensor-val { font-size:18px; font-weight:bold; color:#333; display:block; margin-bottom:4px; }
        
        /* Popup City */
        .popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:200; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
        .popup-box { background:white; width:85%; max-width:350px; border-radius:20px; padding:20px; max-height:80vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        .city-item { padding:15px; border-bottom:1px solid #eee; cursor:pointer; font-weight:500; display:flex; align-items:center; }
        .city-item:hover { background:#f1f8e9; color:var(--primary); }

        /* B·∫£ng l·ªãch s·ª≠ */
        .history-table { width:100%; border-collapse:collapse; font-size:13px; margin-top:10px; }
        .history-table th { text-align:left; color:#777; padding:10px; border-bottom:1px solid #eee; font-weight:normal; }
        .history-table td { padding:10px; border-bottom:1px solid #f9f9f9; }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

<div id="screenRegion" class="screen">
    <h2 style="color:var(--primary); margin-bottom:30px">üåè B·∫°n ƒëang ·ªü ƒë√¢u?</h2>
    <button class="btn-big" onclick="selectRegion('NORTH')">Mi·ªÅn B·∫Øc</button>
    <button class="btn-big" onclick="selectRegion('CENTRAL')">Mi·ªÅn Trung</button>
    <button class="btn-big" onclick="selectRegion('SOUTH')">Mi·ªÅn Nam</button>
    <div style="margin-top:20px; font-size:12px; color:#888">Ch·ªçn v√πng ƒë·ªÉ t·ªëi ∆∞u AI theo kh√≠ h·∫≠u</div>
</div>

<div id="screenMode" class="screen" style="display:none">
    <h2 style="color:#673ab7; margin-bottom:30px">‚öôÔ∏è Ch·ªçn Ch·∫ø ƒê·ªô</h2>
    <button class="btn-big" style="border:2px solid #673ab7; color:#673ab7" onclick="enterMode('AUTO')">ü§ñ AI T·ª∞ ƒê·ªòNG</button>
    <button class="btn-big" onclick="enterMode('MANUAL')">üéÆ ƒêI·ªÄU KHI·ªÇN TAY</button>
    <div style="margin-top:30px; text-decoration:underline; cursor:pointer; color:#777" onclick="backStep()">‚¨Ö Quay l·∫°i</div>
</div>

<div id="mainApp">
    <div class="card" style="padding:15px 20px; display:flex; justify-content:space-between; align-items:center">
        <b style="color:var(--primary); font-size:18px">üå± Smart Garden</b>
        <div>
            <span onclick="resetConfig()" style="font-size:12px; cursor:pointer; margin-right:15px; color:#555">‚öôÔ∏è C√†i ƒë·∫∑t</span>
            <a href="/logout" style="color:var(--danger); text-decoration:none; font-size:12px; font-weight:bold">Tho√°t</a>
        </div>
    </div>

    <div class="card">
        <div style="text-align:center; margin-bottom:10px">
            <div style="font-weight:bold; font-size:16px; display:flex; justify-content:center; align-items:center; color:#444">
                üìç <span id="loc">ƒêang t√¨m v·ªã tr√≠...</span>
                <span onclick="openCityPopup()" style="cursor:pointer; margin-left:8px; color:var(--primary); font-size:18px">‚úèÔ∏è</span>
            </div>
            <div style="font-size:12px; color:#888; margin-top:5px" id="modeLabel">--</div>
        </div>

        <div class="soil-circle" id="soilBox">
            <span class="soil-val" id="soil">--</span>
            <span style="font-size:11px; color:#888; font-weight:bold">ƒê·ªò ·∫®M ƒê·∫§T (%)</span>
        </div>
        
        <div style="text-align:center; margin-top:15px; font-weight:bold; color:#555" id="pumpSt">--</div>
        <div style="text-align:center; color:var(--danger); font-weight:bold; height:20px; font-size:14px; margin-top:5px" id="warn"></div>

        <div class="grid-3">
            <div class="sensor-box"><span class="sensor-val" id="temp">--</span>Nhi·ªát ƒë·ªô</div>
            <div class="sensor-box"><span class="sensor-val" id="hum">--</span>Kh√¥ng kh√≠</div>
            <div class="sensor-box"><span class="sensor-val" id="rain">--</span>M∆∞a</div>
        </div>

        <div id="panelAuto" style="display:none; background:#ede7f6; padding:15px; border-radius:12px; margin-top:15px; font-size:14px; line-height:1.6; border: 1px solid #d1c4e9;">
            <b style="color:#673ab7">ü§ñ AI GEMINI:</b><br>
            M·ª•c ti√™u gi·ªØ ·∫©m: <b id="aiTarget">--%</b><br>
            <span style="color:#555; font-style:italic">" <span id="aiReason">...</span> "</span>
        </div>
        
        <div id="panelManual" style="display:none">
            <button id="btnOn" class="btn-pump" style="background:#2e7d32" onclick="pump(true)">B·∫¨T B∆†M N∆Ø·ªöC üíß</button>
            <button id="btnOff" class="btn-pump" style="background:#c62828; display:none" onclick="pump(false)">T·∫ÆT B∆†M NGAY ‚õî</button>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
            <b>üìú Nh·∫≠t K√Ω</b>
            <button onclick="loadHistory()" style="font-size:16px; border:none; background:none; cursor:pointer">üîÑ</button>
        </div>
        <table class="history-table">
            <thead><tr><th>Gi·ªù</th><th>ƒê·ªô ·∫©m</th><th>H√†nh ƒë·ªông</th></tr></thead>
            <tbody id="histBody"><tr><td colspan="3" style="text-align:center; color:#999; padding:20px">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr></tbody>
        </table>
    </div>
</div>

<div id="cityPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-box">
        <h3 style="color:var(--primary); margin-top:0">S·ª≠a V·ªã Tr√≠ Th·ªß C√¥ng</h3>
        <p style="font-size:12px; color:#666; margin-bottom:15px">Ch·ªçn ƒë√∫ng n∆°i ·ªü ƒë·ªÉ c·∫≠p nh·∫≠t th·ªùi ti·∫øt:</p>
        <div id="cityList"></div>
        <button onclick="document.getElementById('cityPopup').style.display='none'" style="width:100%; margin-top:15px; padding:12px; border:none; background:#eee; border-radius:8px; font-weight:bold; color:#555">ƒê√≥ng</button>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH MQTT ---
    const CLIENT_ID = 'web_' + Math.random().toString(16).substr(2, 8);
    // QUAN TR·ªåNG: D√πng wss:// cho Render (SSL Secure)
    const BROKER = 'wss://broker.hivemq.com:8884/mqtt'; 
    const PREFIX = "thaocute_smartgarden/";
    
    console.log("Connecting to " + BROKER);
    const client = mqtt.connect(BROKER, { clientId: CLIENT_ID });

    // --- D·ªÆ LI·ªÜU Tƒ®NH ---
    const CITIES = {
        'NORTH': ["H√† N·ªôi", "H·∫£i Ph√≤ng", "Qu·∫£ng Ninh", "L√†o Cai", "S∆°n La", "Nam ƒê·ªãnh", "Th√°i Nguy√™n"],
        'CENTRAL': ["ƒê√† N·∫µng", "Hu·∫ø", "Nha Trang", "Thanh H√≥a", "Vinh", "Quy Nh∆°n", "Qu·∫£ng B√¨nh"],
        'SOUTH': ["TP.HCM", "C·∫ßn Th∆°", "ƒê·ªìng Nai", "V≈©ng T√†u", "B√¨nh D∆∞∆°ng", "C√† Mau", "Ki√™n Giang"]
    };
    let currentRegion = 'NORTH';

    // --- LOGIC GIAO DI·ªÜN ---
    function showStep(s) {
        document.getElementById('screenRegion').style.display = s===0 ? 'flex':'none';
        document.getElementById('screenRegion').style.opacity = s===0 ? 1 : 0;
        
        document.getElementById('screenMode').style.display = s===1 ? 'flex':'none';
        
        document.getElementById('mainApp').style.display = s===2 ? 'block':'none';
        if(s===2) loadHistory();
    }
    showStep(0); // M·∫∑c ƒë·ªãnh

    // --- LOGIC MQTT ---
    client.on('connect', () => { 
        console.log("‚úÖ MQTT Connected!");
        client.subscribe(PREFIX + 'update'); 
        
        // G·ª≠i l·ªánh l·∫•y tr·∫°ng th√°i ngay khi k·∫øt n·ªëi
        setTimeout(() => {
            client.publish(PREFIX + 'events', JSON.stringify({event:'get_status'}));
            client.publish(PREFIX + 'events', JSON.stringify({event:'force_locate'}));
        }, 500);
    });
    
    client.on('message', (t, m) => {
        const d = JSON.parse(m.toString());
        
        // C·∫≠p nh·∫≠t b∆∞·ªõc m√†n h√¨nh (Quan tr·ªçng)
        showStep(d.step);
        
        if(d.region) currentRegion = d.region;

        // C·∫≠p nh·∫≠t th√¥ng s·ªë
        document.getElementById('loc').innerText = d.location;
        document.getElementById('soil').innerText = d.soil;
        document.getElementById('temp').innerText = d.temp + "¬∞C";
        document.getElementById('hum').innerText = d.humidity + "%";
        document.getElementById('rain').innerText = d.rain == 0 ? "Kh√¥ng" : "C√≥ m∆∞a";
        document.getElementById('warn').innerText = d.warning;
        document.getElementById('modeLabel').innerText = d.mode==='AUTO' ? "AUTO (AI T·ª∞ ƒê·ªòNG)" : "ƒêI·ªÄU KHI·ªÇN TH·ª¶ C√îNG";
        
        // ƒê·ªïi m√†u v√≤ng tr√≤n
        let soilColor = "#2e7d32"; // Xanh
        if(d.soil < 30) soilColor = "#d32f2f"; // ƒê·ªè (Kh√¥)
        if(d.soil > 85) soilColor = "#0288d1"; // Xanh bi·ªÉn (∆Ø·ªõt)
        document.getElementById('soilBox').style.borderColor = soilColor;
        document.getElementById('soilBox').style.color = soilColor;

        // Tr·∫°ng th√°i b∆°m
        const isPump = d.pump;
        document.getElementById('pumpSt').innerText = isPump ? "üí¶ M√ÅY B∆†M ƒêANG CH·∫†Y..." : "M√ÅY B∆†M T·∫ÆT";
        document.getElementById('pumpSt').style.color = isPump ? "#0288d1" : "#555";
        
        // ·∫®n/Hi·ªán Panel
        if(d.mode === 'MANUAL') {
            document.getElementById('panelManual').style.display='block';
            document.getElementById('panelAuto').style.display='none';
            document.getElementById('btnOn').style.display = isPump ? 'none' : 'block';
            document.getElementById('btnOff').style.display = isPump ? 'block' : 'none';
        } else {
            document.getElementById('panelManual').style.display='none';
            document.getElementById('panelAuto').style.display='block';
            document.getElementById('aiTarget').innerText = d.ai_target + "%";
            document.getElementById('aiReason').innerText = d.ai_reason;
        }
    });

    // --- H√ÄM G·ª¨I L·ªÜNH ---
    function selectRegion(r) { client.publish(PREFIX+'events', JSON.stringify({event:'select_region', data:{region:r}})); }
    function enterMode(m) { client.publish(PREFIX+'events', JSON.stringify({event:'enter_mode', data:{mode:m}})); }
    function pump(s) { client.publish(PREFIX+'events', JSON.stringify({event:'user_control', data:{pump:s}})); }
    function backStep() { client.publish(PREFIX+'events', JSON.stringify({event:'exit_dashboard'})); }
    
    function resetConfig() {
        if(confirm("C√†i ƒë·∫∑t l·∫°i V√πng v√† Ch·∫ø ƒë·ªô?")) {
            client.publish(PREFIX+'events', JSON.stringify({event:'exit_dashboard'}));
        }
    }

    // --- H√ÄM POPUP & L·ªäCH S·ª¨ ---
    function openCityPopup() {
        const list = document.getElementById('cityList');
        list.innerHTML = "";
        const regionList = CITIES[currentRegion] || CITIES['NORTH'];
        regionList.forEach(city => {
            let div = document.createElement('div');
            div.className = "city-item";
            div.innerHTML = `üìç ${city}`;
            div.onclick = () => {
                client.publish(PREFIX+'events', JSON.stringify({event:'set_city', data:{city:city}}));
                document.getElementById('cityPopup').style.display = 'none';
            };
            list.appendChild(div);
        });
        document.getElementById('cityPopup').style.display = 'flex';
    }

    function loadHistory() {
        fetch('/api/history').then(r=>r.json()).then(data => {
            const tb = document.getElementById('histBody');
            tb.innerHTML = "";
            if(data.length === 0) { tb.innerHTML = "<tr><td colspan='3' style='text-align:center; padding:20px; color:#999'>Ch∆∞a c√≥ nh·∫≠t k√Ω ho·∫°t ƒë·ªông</td></tr>"; return; }
            
            data.forEach(Row => {
                let actColor = Row.action.includes('ON') ? '#2e7d32' : (Row.action.includes('OFF') ? '#c62828' : '#673ab7');
                let dotColor = Row.soil < 30 ? '#c62828' : '#2e7d32';
                
                tb.innerHTML += `
                <tr>
                    <td>${Row.time}</td>
                    <td><span class="status-dot" style="background:${dotColor}"></span>${Row.soil}%</td>
                    <td style="color:${actColor}; font-weight:600">${Row.action}</td>
                </tr>`;
            });
        });
    }
    
    // T·ª± ƒë·ªông load l·ªãch s·ª≠ 10s/l·∫ßn
    setInterval(loadHistory, 10000);
</script>
</body>
</html>
