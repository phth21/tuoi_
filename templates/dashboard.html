<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Garden Monitor</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00b894;
            --danger: #e74c3c;
            --dark: #2d3436;
            --bg-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        body {margin:0;font-family:'Roboto',sans-serif;background:var(--bg-gradient);min-height:100vh;color:var(--dark);}
        .screen {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.97);z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center;}
        #mainApp {display:none;max-width:1000px;margin:20px auto;padding:0 20px;}
        .card {background:rgba(255,255,255,0.95);backdrop-filter:blur(15px);border-radius:24px;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,0.1);}
        .top-bar {display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
        .btn-nav {background:var(--dark);color:white;border:none;padding:10px 20px;border-radius:12px;font-weight:700;cursor:pointer;font-size:0.95rem;}
        .dashboard-grid {display:grid;grid-template-columns:1fr 1fr;gap:30px;}
        @media (max-width:768px){.dashboard-grid{grid-template-columns:1fr;}}
        .soil-container {width:260px;height:260px;margin:0 auto 25px;}
        .soil-circle {width:100%;height:100%;border-radius:50%;border:20px solid #f0f0f0;background:white;display:flex;flex-direction:column;justify-content:center;align-items:center;box-shadow:0 10px 30px rgba(0,0,0,0.1);transition:all 0.5s;}
        .soil-val {font-size:4.8rem;font-weight:900;color:var(--primary);line-height:1;}
        .soil-label {font-size:1.2rem;color:#777;margin-top:8px;}
        .emergency {border-color:var(--danger)!important;animation:pulse 1.8s infinite;}
        @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(231,76,60,0.4);}70%{box-shadow:0 0 0 30px rgba(231,76,60,0);}}
        .location-box {text-align:center;margin-bottom:25px;}
        .location-name {font-size:1.9rem;font-weight:700;margin:10px 0 5px;}
        .location-sub {font-size:0.95rem;color:#777;}
        .sensor-grid {display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin:30px 0;}
        .sensor-item {background:#f8f9fa;padding:20px;border-radius:18px;text-align:center;}
        .sensor-val {font-size:1.8rem;font-weight:700;color:var(--primary);}
        .sensor-label {font-size:0.9rem;color:#666;display:block;margin-top:6px;}
        .control-panel {background:#f8f9fa;padding:28px;border-radius:20px;}
        .mode-title {font-size:1.5rem;font-weight:700;color:var(--primary);margin-bottom:18px;text-align:center;}
        .ai-box {background:white;padding:22px;border-radius:16px;border-left:7px solid var(--primary);font-size:1.05rem;line-height:1.8;}
        .ai-box strong {color:var(--primary);}
        .btn-pump {width:100%;padding:20px;margin:12px 0;border:none;border-radius:16px;font-size:1.4rem;font-weight:700;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;}
        .btn-on {background:linear-gradient(135deg,#00b894,#55efc4);}
        .btn-off {background:linear-gradient(135deg,#e17055,#ff7675);}
        .viewer-disabled {opacity:0.4;pointer-events:none;}
        .popup-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:999;justify-content:center;align-items:center;}
        .popup-content {background:white;width:90%;max-width:500px;border-radius:20px;padding:25px;max-height:85vh;overflow-y:auto;}
    </style>
</head>
<body>

<div id="screenRegion" class="screen">
    <h1 style="color:var(--primary)">üåè Ch·ªçn Khu V·ª±c</h1>
    <div style="display:flex;flex-direction:column;gap:10px;width:200px">
        <button class="btn-nav" onclick="emit('select_region',{region:'NORTH'})">Mi·ªÅn B·∫Øc</button>
        <button class="btn-nav" onclick="emit('select_region',{region:'CENTRAL'})">Mi·ªÅn Trung</button>
        <button class="btn-nav" onclick="emit('select_region',{region:'SOUTH'})">Mi·ªÅn Nam</button>
    </div>
</div>

<div id="screenMode" class="screen" style="display:none">
    <h1 style="color:#0984e3">‚öôÔ∏è Ch·ªçn Ch·∫ø ƒê·ªô</h1>
    <div style="display:flex;gap:20px;margin-top:20px">
        <div onclick="emit('enter_mode',{mode:'AUTO'})" style="cursor:pointer;padding:30px;background:#e3f2fd;border-radius:20px;text-align:center">
            <div style="font-size:3rem">ü§ñ</div><h3>AUTO</h3>
        </div>
        <div onclick="emit('enter_mode',{mode:'MANUAL'})" style="cursor:pointer;padding:30px;background:#fff3e0;border-radius:20px;text-align:center">
            <div style="font-size:3rem">üéÆ</div><h3>TH·ª¶ C√îNG</h3>
        </div>
    </div>
</div>

<div id="mainApp">
    <div class="card">
        <div class="top-bar">
            {% if role != 'VIEWER' %}
                <button class="btn-nav" onclick="exit()">‚¨Ö Menu</button>
            {% else %}
                <div style="background:#ffeaa7;color:#d35400;padding:8px 18px;border-radius:20px;font-weight:bold;">üëÅÔ∏è Ch·∫ø ƒë·ªô KH√ÅCH</div>
            {% endif %}
            <a href="/logout" class="btn-nav">ƒêƒÉng xu·∫•t</a>
        </div>

        <div style="text-align:center;margin-bottom:15px;color:#00b894;font-size:0.9rem;" id="mqttStatus">üîå Connecting...</div>

        <div class="dashboard-grid">
            <div style="text-align:center">
                <div class="soil-container">
                    <div class="soil-circle" id="soilBox">
                        <div class="soil-val" id="soil">--</div>
                        <div class="soil-label">% ƒê·ªò ·∫®M ƒê·∫§T</div>
                    </div>
                </div>
                <h3 id="pumpSt" style="margin:15px 0;font-size:1.5rem;color:#636e72;">M√ÅY B∆†M T·∫ÆT</h3>
                <div id="warn" style="color:var(--danger);font-weight:700;min-height:28px;font-size:1.1rem;"></div>
                <button onclick="openHistory()" class="btn-nav" style="width:100%;background:#6c5ce7;margin-top:20px;padding:14px;">üìÖ Xem l·ªãch s·ª≠</button>
            </div>

            <div>
                <div class="location-box">
                    <div>
                        <div class="location-sub">V·ªã tr√≠ hi·ªán t·∫°i</div>
                        <div class="location-name" id="loc">Ch∆∞a x√°c ƒë·ªãnh</div>
                    </div>
                    {% if role != 'VIEWER' %}
                    <div style="display:flex;gap:10px;margin-top:12px;justify-content:center;">
                        <button onclick="getRealGPS()" style="background:#00b894;color:white;border:none;padding:12px 18px;border-radius:12px;font-weight:600;">üìç ƒê·ªãnh v·ªã t√¥i</button>
                        <button onclick="openCityPopup()" style="background:#dfe6e9;border:none;padding:12px 18px;border-radius:12px;font-weight:600;">‚úé Ch·ªçn TP</button>
                    </div>
                    {% endif %}
                </div>

                <div class="sensor-grid">
                    <div class="sensor-item"><span class="sensor-val" id="temp">--¬∞</span><span class="sensor-label">Nhi·ªát ƒë·ªô</span></div>
                    <div class="sensor-item"><span class="sensor-val" id="hum">--%</span><span class="sensor-label">ƒê·ªô ·∫©m kh√¥ng kh√≠</span></div>
                    <div class="sensor-item"><span class="sensor-val" id="rain">--</span><span class="sensor-label">L∆∞·ª£ng m∆∞a (mm/h)</span></div>
                </div>

                <div class="control-panel">
                    <div id="panelAuto" style="display:none">
                        <div class="mode-title">ü§ñ CH·∫æ ƒê·ªò T·ª∞ ƒê·ªòNG (AI)</div>
                        <div class="ai-box">
                            <div>‚è± <strong>K·∫ø ho·∫°ch t∆∞·ªõi:</strong> <span id="aiTime">ƒêang ph√¢n t√≠ch...</span></div>
                            <div style="margin-top:12px;">üéØ <strong>M·ª•c ti√™u ƒë·ªô ·∫©m:</strong> <span id="aiTarget">Ch∆∞a x√°c ƒë·ªãnh</span></div>
                            <div style="margin-top:12px;">üí° <strong>L√Ω do:</strong> <span id="aiReason">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</span></div>
                        </div>
                    </div>

                    <div id="panelManual" style="display:none">
                        <div class="{% if role == 'VIEWER' %}viewer-disabled{% endif %}">
                            <button class="btn-pump btn-on" onclick="pump(true)">üíß B·∫¨T M√ÅY B∆†M</button>
                            <button class="btn-pump btn-off" onclick="pump(false)">‚õî T·∫ÆT M√ÅY B∆†M</button>
                        </div>
                        {% if role == 'VIEWER' %}<div style="text-align:center;color:#999;margin-top:12px;">üîí Ch·ªâ ƒë∆∞·ª£c xem</div>{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Popup gi·ªØ nguy√™n logic c≈© c·ªßa b·∫°n -->
<div id="cityPopup" class="popup-overlay" onclick="if(event.target==this)this.style.display='none'"> 
    <div class="popup-content" style="width:300px;text-align:center">
        <h3>üìç Ch·ªçn Th·ªß C√¥ng</h3>
        <div id="cityList" style="display:flex;flex-direction:column;gap:5px;max-height:300px;overflow-y:auto"></div>
        <button onclick="document.getElementById('cityPopup').style.display='none'" style="margin-top:15px;padding:10px;">ƒê√≥ng</button>
    </div>
</div>

<div id="historyPopup" class="popup-overlay" onclick="if(event.target==this)this.style.display='none'">
    <div class="popup-content">
        <div style="display:flex;justify-content:space-between"><h3>üìú Nh·∫≠t K√Ω</h3><button onclick="document.getElementById('historyPopup').style.display='none'" style="border:none;background:none;font-size:1.5rem">√ó</button></div>
        <div style="display:flex;gap:10px;margin:15px 0">
            <input type="date" id="dateInput" onchange="loadHistory()" style="padding:8px;border:1px solid #ddd;flex:1">
            <select id="actionFilter" onchange="filterAndRender()" style="padding:8px;border:1px solid #ddd">
                <option value="ALL">T·∫•t c·∫£</option><option value="PUMP">B∆°m</option><option value="AI">AI</option>
            </select>
        </div>
        <div style="overflow-y:auto;flex:1"><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:12px;background:#f8f9fa">Gi·ªù</th><th style="text-align:left;padding:12px;background:#f8f9fa">H√†nh ƒë·ªông</th><th style="text-align:left;padding:12px;background:#f8f9fa">Chi ti·∫øt</th></tr></thead><tbody id="histBody"></tbody></table></div>
    </div>
</div>

<script>
    const BROKER_URL = 'wss://broker.hivemq.com:8884/mqtt';
    const PREFIX = "thaocute_smartgarden/";
    const USER_ROLE = "{{ role }}";
    const client = mqtt.connect(BROKER_URL, {keepalive:60, clientId:'Web_'+Math.random().toString(16).substr(2,8)});
    const REGIONAL_CITIES = {'NORTH':["H√† N·ªôi","H·∫£i Ph√≤ng","L√†o Cai"],'CENTRAL':["ƒê√† N·∫µng","Hu·∫ø","Nha Trang"],'SOUTH':["TP.HCM","C·∫ßn Th∆°","C√† Mau"]};
    let currentRegion = 'NORTH', rawHistoryData = [];

    client.on('connect', () => {
        console.log("MQTT OK");
        document.getElementById('mqttStatus').innerText = "üü¢ Online";
        document.getElementById('mqttStatus').style.color = "#00b894";
        client.subscribe(PREFIX + 'update');
        if(USER_ROLE !== 'VIEWER' && "geolocation" in navigator){
            navigator.geolocation.getCurrentPosition(p => emit('set_gps',{lat:p.coords.latitude,lon:p.coords.longitude}), e => console.log("GPS l·ªói"));
        }
    });

    client.on('message', (topic, msg) => {
        if(topic === PREFIX + 'update') try { updateUI(JSON.parse(msg.toString())); } catch(e){}
    });

    function updateUI(d){
        if(!d) return;
        currentRegion = d.region;

        if(USER_ROLE==='VIEWER'){
            document.getElementById('screenRegion').style.display='none';
            document.getElementById('screenMode').style.display='none';
            document.getElementById('mainApp').style.display='block';
        }else{
            document.getElementById('screenRegion').style.display = (d.step===0)?'flex':'none';
            document.getElementById('screenMode').style.display = (d.step===1)?'flex':'none';
            document.getElementById('mainApp').style.display = (d.step===2)?'block':'none';
        }

        document.getElementById('loc').innerText = d.location || "Ch∆∞a x√°c ƒë·ªãnh";
        document.getElementById('soil').innerText = d.soil;
        document.getElementById('temp').innerText = d.temp + "¬∞";
        document.getElementById('hum').innerText = d.humidity + "%";
        document.getElementById('rain').innerText = d.rain || "0";
        document.getElementById('warn').innerText = d.warning;

        const soilBox = document.getElementById('soilBox');
        if(parseInt(d.soil)<26){ soilBox.classList.add('emergency'); }
        else{ soilBox.classList.remove('emergency'); }

        const pst = document.getElementById('pumpSt');
        if(d.pump){ pst.innerHTML="üí¶ ƒêANG B∆†M..."; pst.style.color="#00b894"; }
        else{ pst.innerHTML="üí§ M√ÅY B∆†M T·∫ÆT"; pst.style.color="#636e72"; }

        document.getElementById('panelAuto').style.display = (d.mode==='AUTO')?'block':'none';
        document.getElementById('panelManual').style.display = (d.mode==='MANUAL')?'block':'none';

        if(d.mode==='AUTO'){
            document.getElementById('aiTime').innerText = d.ai_timing || "ƒêang ph√¢n t√≠ch...";
            document.getElementById('aiTarget').innerText = d.ai_target || "Ch∆∞a x√°c ƒë·ªãnh";
            document.getElementById('aiReason').innerText = d.ai_reason || "ƒêang x·ª≠ l√Ω...";
        }
    }

    function emit(ev, data){ 
        if(USER_ROLE==='VIEWER' && ['user_control','set_city','select_region','enter_mode'].includes(ev)){ alert("üö´ Kh√°ch kh√¥ng c√≥ quy·ªÅn!"); return; }
        client.publish(PREFIX+'events', JSON.stringify({event:ev, data:data||{}}));
    }
    function pump(st){ emit('user_control',{pump:st}); }
    function exit(){ if(confirm("V·ªÅ menu?")) emit('exit_dashboard',{}); }
    function getRealGPS(){
        if(!navigator.geolocation) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£");
        document.getElementById('loc').innerText="üì° ƒêang d√≤...";
        navigator.geolocation.getCurrentPosition(
            p=>{ emit('set_gps',{lat:p.coords.latitude,lon:p.coords.longitude}); alert("‚úÖ ƒê·ªãnh v·ªã th√†nh c√¥ng"); },
            e=>{ alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS"); document.getElementById('loc').innerText="L·ªói"; }
        );
    }
    function openCityPopup(){
        const list=document.getElementById('cityList'); list.innerHTML="";
        (REGIONAL_CITIES[currentRegion]||[]).forEach(c=>{
            let btn=document.createElement('button'); btn.innerText=c;
            btn.style.padding="10px"; btn.style.width="100%"; btn.style.background="white"; btn.style.border="1px solid #eee";
            btn.onclick=()=>{ emit('set_city',{city:c}); document.getElementById('cityPopup').style.display='none'; };
            list.appendChild(btn);
        });
        document.getElementById('cityPopup').style.display='flex';
    }
    function openHistory(){ document.getElementById('historyPopup').style.display='flex'; document.getElementById('dateInput').valueAsDate=new Date(); loadHistory(); }
    function loadHistory(){
        fetch('/api/history?date='+document.getElementById('dateInput').value)
            .then(r=>r.json()).then(data=>{ rawHistoryData=data||[]; filterAndRender(); })
            .catch(()=>{ document.getElementById('histBody').innerHTML='<tr><td colspan="3">L·ªói k·∫øt n·ªëi</td></tr>'; });
    }
    function filterAndRender(){
        const filter=document.getElementById('actionFilter').value;
        const tbody=document.getElementById('histBody'); tbody.innerHTML="";
        let data = rawHistoryData.filter(i=> filter==='ALL' || (filter==='PUMP' && i.action.includes('PUMP')) || (filter==='AI' && i.action.includes('AI')));
        if(data.length===0){ tbody.innerHTML='<tr><td colspan="3" style="text-align:center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'; return; }
        data.forEach(i=>{
            let color = i.action.includes('ON')||i.action.includes('B·∫¨T')?'#00b894':'#0984e3';
            tbody.innerHTML+=`<tr><td><b>${i.time}</b></td><td><span style="color:${color};font-weight:bold">${i.action}</span></td><td>${i.detail||''}</td></tr>`;
        });
    }
</script>
</body>
</html>
