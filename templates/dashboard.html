<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Garden Monitor</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        /* --- 1. PH√îNG CH·ªÆ & RESET --- */
        * { box-sizing: border-box; }
        body {
            margin: 0; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; /* 1 Ph√¥ng duy nh·∫•t */
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- 2. LAYOUT CHUNG --- */
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #mainApp { display: none; width: 100%; max-width: 600px; padding: 15px; }
        .card { 
            background: white; border-radius: 12px; padding: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px;
        }

        /* --- 3. N√öT B·∫§M (BUTTONS) --- */
        .btn {
            border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; 
            cursor: pointer; transition: 0.2s; font-size: 1rem; width: 100%; display: block; text-align: center; text-decoration: none;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #555; }
        
        /* --- 4. TH√ÄNH PH·∫¶N DASHBOARD --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .status-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #eee; color: #666; }
        
        /* Circle Soil */
        .soil-wrapper { display: flex; justify-content: center; margin: 20px 0; }
        .soil-circle {
            width: 180px; height: 180px; border-radius: 50%; 
            border: 10px solid #e9ecef;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .soil-val { font-size: 3rem; font-weight: bold; color: #28a745; line-height: 1; }
        .soil-label { font-size: 0.9rem; color: #888; margin-top: 5px; }
        .warning-text { color: #dc3545; font-weight: bold; text-align: center; height: 20px; margin-top: 5px; }

        /* Info Grid */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .info-box { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .info-val { font-size: 1.2rem; font-weight: bold; display: block; }
        .info-lbl { font-size: 0.75rem; color: #888; }

        /* Location */
        .location-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #e9ecef; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px;
        }

        /* --- 5. L·ªäCH S·ª¨ (THAY TH·∫æ CHART) --- */
        .history-panel { margin-top: 20px; }
        .history-header { font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .hist-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .hist-item { 
            display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f1f1; font-size: 0.9rem; 
        }
        .hist-time { color: #888; font-size: 0.8rem; min-width: 60px; }
        .hist-action { font-weight: 600; flex: 1; padding-left: 10px; }

        /* Utils */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
    </style>
</head>
<body>

<div id="screenRegion" class="screen">
    <h2>üåè Ch·ªçn Khu V·ª±c</h2>
    <div style="width: 200px; display: flex; flex-direction: column; gap: 10px;">
        <button class="btn btn-outline" onclick="emit('select_region', {region:'NORTH'})">Mi·ªÅn B·∫Øc</button>
        <button class="btn btn-outline" onclick="emit('select_region', {region:'CENTRAL'})">Mi·ªÅn Trung</button>
        <button class="btn btn-outline" onclick="emit('select_region', {region:'SOUTH'})">Mi·ªÅn Nam</button>
    </div>
</div>

<div id="screenMode" class="screen hidden">
    <h2>‚öôÔ∏è Ch·ªçn Ch·∫ø ƒê·ªô</h2>
    <div style="display: flex; gap: 15px;">
        <div onclick="emit('enter_mode', {mode:'AUTO'})" style="cursor:pointer; padding:30px; background:#e3f2fd; border-radius:12px; text-align:center">
            <div style="font-size:3rem">ü§ñ</div><h3>AUTO</h3>
        </div>
        <div onclick="emit('enter_mode', {mode:'MANUAL'})" style="cursor:pointer; padding:30px; background:#fff3e0; border-radius:12px; text-align:center">
            <div style="font-size:3rem">üéÆ</div><h3>TH·ª¶ C√îNG</h3>
        </div>
    </div>
</div>

<div id="mainApp">
    <div class="card">
        <div class="top-bar">
            {% if role != 'VIEWER' %} <button class="btn btn-secondary" style="width: auto; padding: 5px 15px;" onclick="exit()">‚¨Ö Menu</button>
            {% else %} <span class="status-badge">Kh√°ch</span> {% endif %}
            <div id="connStatus" style="color: green; font-size: 0.8rem;">‚óè Online</div>
            <a href="/logout" style="color: #888; text-decoration: none; font-size: 0.9rem;">Tho√°t</a>
        </div>

        <div class="location-bar">
            <div>
                <div style="font-size: 0.75rem; color: #666;">V·ªã tr√≠ hi·ªán t·∫°i</div>
                <div id="locName" style="font-weight: bold; font-size: 1.1rem;">ƒêang t·∫£i...</div>
            </div>
            {% if role != 'VIEWER' %}
            <button class="btn btn-primary" style="width: auto; font-size: 0.8rem;" onclick="getRealGPS()">üìç ƒê·ªãnh v·ªã t√¥i</button>
            {% endif %}
        </div>

        <div class="soil-wrapper">
            <div class="soil-circle" id="soilBox">
                <span class="soil-val" id="soilVal">--</span>
                <span class="soil-label">% ƒê·ªò ·∫®M ƒê·∫§T</span>
            </div>
        </div>
        <div id="pumpStatus" class="text-center" style="color: #666; margin-bottom: 5px;">B∆°m ƒëang t·∫Øt</div>
        <div id="warnMsg" class="warning-text"></div>

        <div class="info-grid">
            <div class="info-box"><span class="info-val" id="tempVal">--¬∞C</span><span class="info-lbl">Nhi·ªát ƒë·ªô</span></div>
            <div class="info-box"><span class="info-val" id="humVal">--%</span><span class="info-lbl">Kh√¥ng kh√≠</span></div>
            <div class="info-box"><span class="info-val" id="rainVal">--</span><span class="info-lbl">M∆∞a (mm)</span></div>
        </div>

        <div id="panelAuto" class="hidden" style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
            <strong style="color: #2e7d32">ü§ñ AI ƒêang T·ª± ƒê·ªông</strong>
            <p style="margin: 5px 0; font-size: 0.9rem;">D·ª± ki·∫øn: <b id="aiTime">...</b></p>
            <p style="margin: 0; font-size: 0.85rem; font-style: italic; color: #555;">"<span id="aiReason">...</span>"</p>
        </div>

        <div id="panelManual" class="hidden">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-success" onclick="controlPump(true)">B·∫¨T B∆†M</button>
                <button class="btn btn-danger" onclick="controlPump(false)">T·∫ÆT B∆†M</button>
            </div>
            {% if role == 'VIEWER' %}<p class="text-center" style="font-size: 0.8rem; color: #999; margin-top:5px;">B·∫°n ch·ªâ c√≥ quy·ªÅn xem</p>{% endif %}
        </div>

        <div class="history-panel">
            <div class="history-header">üìú L·ªãch s·ª≠ ho·∫°t ƒë·ªông (M·ªõi nh·∫•t)</div>
            <ul id="historyList" class="hist-list">
                <li class="hist-item text-center">ƒêang t·∫£i d·ªØ li·ªáu...</li>
            </ul>
        </div>
    </div>
</div>

<script>
    const BROKER = 'wss://broker.hivemq.com:8884/mqtt';
    const PREFIX = "thaocute_smartgarden/";
    const ROLE = "{{ role }}";
    
    // K·∫øt n·ªëi MQTT
    const client = mqtt.connect(BROKER, { clientId: 'Web_' + Math.random().toString(16).substr(2, 8) });

    client.on('connect', () => {
        console.log("MQTT Connected");
        client.subscribe(PREFIX + 'update');
        // T·ª± ƒë·ªông load l·ªãch s·ª≠ l·∫ßn ƒë·∫ßu
        loadHistory();
        // C·ª© 10 gi√¢y load l·∫°i l·ªãch s·ª≠ 1 l·∫ßn
        setInterval(loadHistory, 10000);
    });

    client.on('message', (topic, msg) => {
        if (topic === PREFIX + 'update') renderUI(JSON.parse(msg.toString()));
    });

    function renderUI(d) {
        // ƒêi·ªÅu h∆∞·ªõng m√†n h√¨nh
        if (ROLE === 'VIEWER') {
            document.getElementById('screenRegion').classList.add('hidden');
            document.getElementById('screenMode').classList.add('hidden');
            document.getElementById('mainApp').style.display = 'block';
        } else {
            document.getElementById('screenRegion').classList.toggle('hidden', d.step !== 0);
            document.getElementById('screenMode').classList.toggle('hidden', d.step !== 1);
            document.getElementById('mainApp').style.display = (d.step === 2) ? 'block' : 'none';
        }

        // C·∫≠p nh·∫≠t s·ªë li·ªáu
        document.getElementById('locName').innerText = d.location; // T√™n t·ªânh/th√†nh
        document.getElementById('soilVal').innerText = d.soil;
        document.getElementById('tempVal').innerText = d.temp + "¬∞C";
        document.getElementById('humVal').innerText = d.humidity + "%";
        document.getElementById('rainVal').innerText = d.rain;
        document.getElementById('warnMsg').innerText = d.warning;

        // M√†u s·∫Øc v√≤ng tr√≤n ƒë·∫•t
        const soilBox = document.getElementById('soilBox');
        if (d.soil < 26) soilBox.style.borderColor = "#dc3545"; // ƒê·ªè
        else soilBox.style.borderColor = "#e9ecef"; // X√°m

        // Tr·∫°ng th√°i b∆°m
        const pSt = document.getElementById('pumpStatus');
        if (d.pump) { pSt.innerHTML = "üí¶ ƒêANG B∆†M N∆Ø·ªöC..."; pSt.style.color = "#007bff"; font-weight: bold; }
        else { pSt.innerHTML = "üí§ M√°y b∆°m ƒëang ngh·ªâ"; pSt.style.color = "#666"; }

        // Ch·∫ø ƒë·ªô AI/Manual
        document.getElementById('panelAuto').classList.toggle('hidden', d.mode !== 'AUTO');
        document.getElementById('panelManual').classList.toggle('hidden', d.mode !== 'MANUAL');
        
        if (d.mode === 'AUTO') {
            document.getElementById('aiTime').innerText = d.ai_timing;
            document.getElementById('aiReason').innerText = d.ai_reason;
        }
    }

    // --- C√ÅC H√ÄM X·ª¨ L√ù ---
    function emit(ev, data) {
        if (ROLE === 'VIEWER' && ev !== 'exit_dashboard') return alert("B·∫°n ch·ªâ c√≥ quy·ªÅn xem!");
        client.publish(PREFIX + 'events', JSON.stringify({event: ev, data: data}));
    }

    function controlPump(state) { emit('user_control', {pump: state}); }
    function exit() { if(confirm("V·ªÅ menu ch√≠nh?")) emit('exit_dashboard', {}); }

    function getRealGPS() {
        if (!navigator.geolocation) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS");
        document.getElementById('locName').innerText = "ƒêang d√≤ v·ªá tinh...";
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                emit('set_gps', { lat: pos.coords.latitude, lon: pos.coords.longitude });
                // Kh√¥ng c·∫ßn alert, UI s·∫Ω t·ª± ƒë·ªïi khi server ph·∫£n h·ªìi t√™n
            },
            () => { alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠!"); document.getElementById('locName').innerText = "L·ªói GPS"; }
        );
    }

    // --- H√ÄM L·∫§Y L·ªäCH S·ª¨ (HI·ªÇN TH·ªä TR·ª∞C TI·∫æP) ---
    function loadHistory() {
        fetch('/api/history')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('historyList');
                list.innerHTML = "";
                if (data.length === 0) {
                    list.innerHTML = '<li class="hist-item text-center">Ch∆∞a c√≥ d·ªØ li·ªáu h√¥m nay</li>';
                    return;
                }
                data.forEach(item => {
                    let color = item.action.includes('ON') ? 'green' : (item.action.includes('OFF') ? 'red' : 'blue');
                    let html = `
                        <li class="hist-item">
                            <span class="hist-time">${item.time}</span>
                            <span class="hist-action" style="color:${color}">${item.action}</span>
                            <span>${item.detail}</span>
                        </li>
                    `;
                    list.innerHTML += html;
                });
            })
            .catch(e => console.log(e));
    }
</script>

</body>
</html>
