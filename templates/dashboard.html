<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Smart Garden Pro</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary:#2e7d32; --bg-app:#e8f5e9; --text-main:#1b5e20; --danger:#d32f2f; --ai-color:#673ab7; --ai-bg:#ede7f6; }
        body { margin:0; font-family:'Be Vietnam Pro', sans-serif; background:var(--bg-app); min-height:100vh; display:flex; justify-content:center; color:#333; }
        .screen { position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, #e8f5e9, #c8e6c9); z-index:100; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; box-sizing:border-box; }
        .btn-big { width:100%; max-width:320px; padding:18px; margin:10px 0; border:none; border-radius:16px; background:white; box-shadow:0 4px 15px rgba(46,125,50,0.15); font-size:16px; font-weight:700; display:flex; align-items:center; gap:15px; cursor:pointer; }
        #mainApp { display:none; width:100%; max-width:480px; padding:15px; }
        .card { background:white; border-radius:24px; padding:20px; box-shadow:0 10px 30px rgba(46,125,50,0.1); border:1px solid #dcedc8; }
        .soil-container { display:flex; justify-content:center; margin:15px 0; position:relative; }
        .soil-circle { width:160px; height:160px; border-radius:50%; border:12px solid #f1f8e9; display:flex; flex-direction:column; justify-content:center; align-items:center; transition:all 0.4s ease; background:white; }
        .soil-val { font-size:48px; font-weight:800; color:var(--primary); line-height:1; }
        .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:20px 0; }
        .sensor-box { background:#f9fbe7; padding:12px 5px; border-radius:16px; text-align:center; border:1px solid #f0f4c3; }
        .btn-pump { width:100%; padding:20px; border-radius:16px; border:none; font-weight:bold; color:white; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; }
        .btn-on { background:linear-gradient(135deg, #4caf50, #2e7d32); }
        .btn-off { background:linear-gradient(135deg, #ef5350, #c62828); }
        .popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:200; align-items:center; justify-content:center; backdrop-filter:blur(2px); }
        .popup-box { background:white; width:90%; max-width:450px; border-radius:24px; padding:20px; max-height:85vh; display:flex; flex-direction:column; }
        
        /* CSS CHO B·∫¢NG L·ªäCH S·ª¨ */
        .table-wrap { overflow-y:auto; flex:1; border-radius:12px; border:1px solid #eee; margin-top:10px; }
        table { width:100%; border-collapse:collapse; font-size:13px; }
        th { text-align:left; background:#f1f8e9; color:var(--primary); padding:12px; font-weight:700; position:sticky; top:0; }
        td { padding:12px; border-bottom:1px solid #f5f5f5; color:#444; }
    </style>
</head>
<body>

{% if role != 'VIEWER' %}
<div id="screenRegion" class="screen">
    <h2 style="color:var(--primary)">üåø Khu V·ª±c</h2>
    <button class="btn-big" onclick="selectRegion('NORTH')"><span>üèØ</span> Mi·ªÅn B·∫Øc</button>
    <button class="btn-big" onclick="selectRegion('CENTRAL')"><span>üèñÔ∏è</span> Mi·ªÅn Trung</button>
    <button class="btn-big" onclick="selectRegion('SOUTH')"><span>üå¥</span> Mi·ªÅn Nam</button>
</div>
<div id="screenMode" class="screen" style="display:none">
    <h2 style="color:var(--primary)">‚öôÔ∏è Ch·∫ø ƒê·ªô</h2>
    <button class="btn-big" style="color:var(--ai-color); border:2px solid var(--ai-color)" onclick="emit('enter_mode',{mode:'AUTO'})"><span>ü§ñ</span> Auto (AI)</button>
    <button class="btn-big" onclick="emit('enter_mode',{mode:'MANUAL'})"><span>üéÆ</span> Th·ªß C√¥ng</button>
</div>
{% endif %}

<div id="mainApp">
    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px">
            <div style="font-weight:800; color:var(--primary); font-size:18px">üå± Smart Garden</div>
            <div>
                {% if role != 'VIEWER' %} <button onclick="exit()" style="background:#f1f8e9; border:none; padding:8px; border-radius:8px; cursor:pointer">Menu</button> {% endif %}
                <a href="/logout" style="text-decoration:none; color:var(--danger); background:#ffebee; padding:8px; border-radius:8px; font-size:12px">Tho√°t</a>
            </div>
        </div>

        <div style="text-align:center">
            <div style="font-weight:700">üìç <span id="loc">...</span></div>
            <div style="font-size:11px; color:#777; margin-bottom:10px" id="modeLabel">--</div>
        </div>

        <div class="soil-container">
            <div class="soil-circle" id="soilBox">
                <span class="soil-val" id="soil">--</span><span style="font-size:12px; color:#888; font-weight:600">% ƒê·ªò ·∫®M</span>
            </div>
        </div>
        <div style="text-align:center; font-weight:bold; color:#555; margin-bottom:5px" id="pumpSt">--</div>
        <div style="text-align:center; color:var(--danger); height:18px; font-weight:bold" id="warn"></div>

        <div class="grid-3">
            <div class="sensor-box"><span class="s-val" id="temp">--¬∞</span><br><span style="font-size:11px">Nhi·ªát ƒë·ªô</span></div>
            <div class="sensor-box"><span class="s-val" id="hum">--%</span><br><span style="font-size:11px">Kh√¥ng kh√≠</span></div>
            <div class="sensor-box"><span class="s-val" id="rain">--</span><br><span style="font-size:11px">M∆∞a</span></div>
        </div>

        <div id="panelAuto" style="display:none; background:var(--ai-bg); padding:15px; border-radius:16px; border:1px solid #d1c4e9">
            <div style="color:var(--ai-color); font-weight:bold; font-size:12px; text-align:center; margin-bottom:10px">GEMINI AI CONTROL</div>
            <div style="font-size:14px"><b>M·ª•c ti√™u:</b> <span id="aiTarget" style="background:white; padding:2px 8px; border-radius:6px; font-weight:800">--%</span></div>
            <div style="font-size:14px; margin-top:5px"><b>D·ª± ki·∫øn:</b> <span id="aiTiming">...</span></div>
            <div style="font-size:14px; margin-top:5px"><b>L√Ω do:</b> <span id="aiReason" style="font-style:italic">...</span></div>
        </div>

        <div id="panelManual" style="display:none; padding-top:10px">
            {% if role == 'VIEWER' %} <button class="btn-pump" style="background:#b0bec5">üîí CH·∫æ ƒê·ªò KH√ÅCH</button>
            {% else %}
                <button id="btnOn" class="btn-pump btn-on" onclick="pump(true)">üíß B·∫¨T B∆†M</button>
                <button id="btnOff" class="btn-pump btn-off" onclick="pump(false)" style="display:none">‚õî T·∫ÆT B∆†M</button>
            {% endif %}
        </div>

        <button onclick="openHistory()" style="width:100%; margin-top:15px; padding:12px; background:#e8f5e9; border:none; border-radius:12px; color:var(--primary); font-weight:bold; cursor:pointer">üìÖ Xem Nh·∫≠t K√Ω</button>
    </div>
</div>

<div id="historyPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-box" style="height:80vh">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px">
            <h3 style="margin:0; color:var(--primary)">Nh·∫≠t K√Ω</h3>
            <input type="date" id="dateInput" onchange="loadHistory()" style="border:1px solid #ddd; padding:5px; border-radius:8px">
        </div>
        
        <select id="filterType" onchange="renderHistoryTable()" style="width:100%; padding:8px; border-radius:8px; margin-bottom:10px; border:1px solid #ccc">
            <option value="ALL">Xem t·∫•t c·∫£</option>
            <option value="AI">ü§ñ Ch·ªâ xem AI</option>
            <option value="PUMP">üíß Ch·ªâ xem B∆°m</option>
        </select>

        <div class="table-wrap">
            <table>
                <thead><tr>
                    <th width="15%">Gi·ªù</th>
                    <th width="15%">ƒê·ªô ·∫©m</th> <th width="25%">Hƒê</th>
                    <th>Chi ti·∫øt</th>
                </tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
        <button onclick="document.getElementById('historyPopup').style.display='none'" style="width:100%; margin-top:10px; padding:10px; border:none; background:#eee">ƒê√≥ng</button>
    </div>
</div>

<script>
    const BROKER = 'wss://broker.hivemq.com:8884/mqtt';
    const PREFIX = "thaocute_smartgarden/";
    const ROLE = "{{ role }}" || "VIEWER"; 
    const client = mqtt.connect(BROKER, { keepalive: 60, clientId: 'web_' + Math.random().toString(16).substr(2, 8) });
    let rawHistoryData = [];

    // H√ÄM HI·ªÇN TH·ªä M√ÄN H√åNH
    function checkDisplay(step) {
        if (ROLE === 'VIEWER') { document.getElementById('mainApp').style.display = 'block'; return; }
        ['screenRegion', 'screenMode', 'mainApp'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).style.display='none'; });
        if (step===0) document.getElementById('screenRegion').style.display='flex';
        else if (step===1) document.getElementById('screenMode').style.display='flex';
        else if (step===2) document.getElementById('mainApp').style.display='block';
    }
    checkDisplay(0);

    // MQTT
    client.on('connect', () => { client.subscribe(PREFIX + 'update'); client.publish(PREFIX + 'events', JSON.stringify({event: 'get_status'})); });
    client.on('message', (t, m) => updateUI(JSON.parse(m.toString())));

    function updateUI(d) {
        if (!d) return;
        checkDisplay(d.step);
        
        const setText = (id, v) => { const e=document.getElementById(id); if(e) e.innerText=v; }
        setText('loc', d.location); setText('soil', d.soil); setText('temp', d.temp+"¬∞"); setText('hum', d.humidity+"%"); setText('rain', d.rain); setText('warn', d.warning);
        setText('modeLabel', d.mode==='AUTO'?"CH·∫æ ƒê·ªò: T·ª∞ ƒê·ªòNG":"CH·∫æ ƒê·ªò: TH·ª¶ C√îNG");

        const sb = document.getElementById('soilBox');
        if(sb) sb.style.borderColor = d.soil < 30 ? "#d32f2f" : "#2e7d32";

        if(d.pump) {
            setText('pumpSt', "üí¶ ƒêANG T∆Ø·ªöI...");
            if(document.getElementById('btnOn')) document.getElementById('btnOn').style.display='none';
            if(document.getElementById('btnOff')) document.getElementById('btnOff').style.display='flex';
        } else {
            setText('pumpSt', "M√ÅY B∆†M T·∫ÆT");
            if(document.getElementById('btnOn')) document.getElementById('btnOn').style.display='flex';
            if(document.getElementById('btnOff')) document.getElementById('btnOff').style.display='none';
        }

        const pAuto=document.getElementById('panelAuto'), pManual=document.getElementById('panelManual');
        if(ROLE!=='VIEWER' && d.mode==='AUTO') {
            pAuto.style.display='block'; pManual.style.display='none';
            setText('aiTarget', d.ai_target+"%"); setText('aiTiming', d.ai_timing); setText('aiReason', d.ai_reason);
        } else {
            if(pAuto) pAuto.style.display='none';
            if(pManual) pManual.style.display='block';
        }
    }

    function emit(ev, data) { if(ROLE!=='VIEWER') client.publish(PREFIX+'events', JSON.stringify({event:ev, data:data||{}})); }
    function selectRegion(r) { emit('select_region', {region:r}); }
    function pump(s) { emit('user_control', {pump:s}); }
    function exit() { if(confirm("Tho√°t?")) emit('exit_dashboard', {}); }

    // --- X·ª¨ L√ù L·ªäCH S·ª¨ (ƒê√É S·ª¨A ƒê·ªÇ HI·ªÜN C·ªòT ƒê·ªò ·∫®M) ---
    function openHistory() {
        document.getElementById('historyPopup').style.display='flex';
        const d = document.getElementById('dateInput');
        if(d) { d.valueAsDate = new Date(); loadHistory(); }
    }

    function loadHistory() {
        const d = document.getElementById('dateInput').value;
        const tb = document.getElementById('histBody');
        tb.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px'>ƒêang t·∫£i...</td></tr>";
        fetch('/api/history?date='+d).then(r=>r.json()).then(data=>{ rawHistoryData=data||[]; renderHistoryTable(); }).catch(()=>{});
    }

    function renderHistoryTable() {
        const tb = document.getElementById('histBody');
        const filter = document.getElementById('filterType').value;
        tb.innerHTML = "";

        if(rawHistoryData.length===0) { tb.innerHTML="<tr><td colspan='4' style='text-align:center; color:#999'>Tr·ªëng</td></tr>"; return; }

        const filtered = rawHistoryData.filter(i => {
            if(filter==='ALL') return true;
            if(filter==='AI') return i.action.includes('AI') || i.detail.includes('AI');
            if(filter==='PUMP') return i.action.includes('ON') || i.action.includes('OFF') || i.action.includes('B·∫¨T') || i.action.includes('PUMP');
            return true;
        });

        filtered.forEach(i => {
            let color='#444'; let icon='';
            if(i.action.includes('ON')||i.action.includes('B·∫¨T')) { color='#2e7d32'; icon='üíß'; }
            else if(i.action.includes('OFF')||i.action.includes('T·∫ÆT')) { color='#c62828'; icon='‚õî'; }
            else if(i.action.includes('AI')) { color='#673ab7'; icon='ü§ñ'; }

            // Logic m√†u cho ƒë·ªô ·∫©m
            let soilVal = i.soil || 0;
            let soilColor = soilVal < 30 ? "#d32f2f" : "#2e7d32"; // ƒê·ªè n·∫øu kh√¥, Xanh n·∫øu ·∫©m

            tb.innerHTML += `<tr>
                <td style="color:#777; font-size:11px">${i.time}</td>
                <td style="font-weight:bold; color:${soilColor}">${soilVal}%</td> <td style="color:${color}; font-weight:700">${icon} ${i.action}</td>
                <td style="font-size:12px">${i.detail}</td>
            </tr>`;
        });
    }
</script>
</body>
</html>
