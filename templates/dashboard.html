<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Smart Garden Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  /* --- GI·ªÆ NGUY√äN CSS C≈® --- */
  :root { --bg: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); }
  body { margin:0; font-family: 'Nunito', sans-serif; background: var(--bg); min-height: 100vh; display: flex; justify-content: center; align-items: center; color: #2d3436; padding: 10px; }
  .screen { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 99; display:flex; flex-direction:column; justify-content:center; align-items:center; background: rgba(255,255,255,0.99); transition: 0.3s; }
  .btn { padding: 18px 40px; border:none; border-radius:15px; font-weight:bold; cursor:pointer; color:white; margin: 10px; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  .n { background: #6c5ce7; } .c { background: #0984e3; } .s { background: #d63031; }
  #mainApp { display: none; width: 100%; max-width: 1000px; }
  .card { background: rgba(255,255,255,0.96); border-radius: 30px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); position: relative; }
  .back-btn { position: absolute; top: 20px; left: 20px; background: #ff7675; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; z-index: 10; }
  .logout-btn { position: absolute; top: 20px; right: 20px; background: #636e72; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 0.9rem; }
  .layout { display: grid; grid-template-columns: 300px 1fr; gap: 40px; margin-top: 40px; }
  .soil-circle { width: 240px; height: 240px; border-radius: 50%; border: 15px solid #dfe6e9; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 0 auto; background: white; transition: border-color 0.3s; }
  .soil-num { font-size: 4.5rem; font-weight: 900; color: #00b894; line-height: 1; }
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 25px; }
  .stat-box { background: #f1f2f6; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; color: #555; }
  .stat-val { display: block; font-size: 1.3rem; color: #0984e3; }
  .mode-container { display: flex; gap: 20px; }
  .mode-card { background:white; padding:40px; border-radius:20px; cursor:pointer; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.1); width:200px; border:3px solid transparent; }
  .mode-card:hover { border-color: #00b894; transform: translateY(-5px); }
  #panelAuto, #panelManual { display: none; animation: fadeIn 0.5s; }
  .manual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .p-btn { padding: 30px; border:none; border-radius:15px; font-weight:bold; color:white; font-size:1.3rem; cursor:pointer; width: 100%; }
  .bon { background: #00b894; } .boff { background: #636e72; }
  #cityPopup, #historyPopup { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; justify-content:center; align-items:center; }
  .popup-box { background:white; padding:25px; border-radius:20px; width:300px; text-align:center; max-height:80vh; overflow-y:auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
  .city-opt { display:block; width:100%; padding:12px; border:1px solid #eee; background:white; margin-bottom:5px; border-radius:8px; cursor:pointer; font-weight:bold; transition: 0.2s; }
  .city-opt:hover { background:#f0f0f0; color:#0984e3; transform: translateX(5px); }
  .hist-btn { display:inline-block; margin-top:10px; background:#2d3436; color:white; padding:10px 20px; border-radius:8px; font-weight:bold; border:none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0, 0.3); transition: 0.2s; }
  .table-container { max-height: 350px; overflow-y: auto; border-radius: 8px; border: 1px solid #eee; margin-top: 10px; }
  .hist-table { width: 100%; font-size: 0.9rem; border-collapse: collapse; text-align: left; }
  .hist-table th { position: sticky; top: 0; background: #f1f2f6; color: #636e72; padding: 12px; font-weight: 800; z-index: 1; }
  .hist-table td { padding: 12px; border-bottom: 1px solid #eee; color: #2d3436; vertical-align: middle; }
  .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-block; min-width: 60px; text-align: center; }
  .bg-green { background: #e3f9e5; color: #00b894; border: 1px solid #00b894; }
  .bg-red { background: #ffebeb; color: #d63031; border: 1px solid #d63031; }
  .bg-blue { background: #e3f2fd; color: #0984e3; border: 1px solid #0984e3; }
  .filter-bar { display: flex; gap: 10px; margin-bottom: 10px; }
  .filter-input { padding: 8px; border-radius: 8px; border: 1px solid #ddd; flex: 1; font-weight: bold; }
  .summary-box { background: #e3f2fd; color: #0984e3; padding: 10px; border-radius: 8px; font-weight: bold; margin-bottom: 10px; display: none; }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  .emergency { animation: blink 1s infinite; border-color: red !important; } @keyframes blink { 50% { opacity: 0.5; } }
  @media (max-width: 800px) { .layout { grid-template-columns: 1fr; } .mode-container { flex-direction:column; } }
</style>
</head>
<body>

<div id="screenRegion" class="screen">
  <h1>üå± Smart Garden</h1>
  <p>Xin ch√†o <b>{{ user }}</b>! Ch·ªçn khu v·ª±c:</p>
  <div>
    <button class="btn n" onclick="emit('select_region', {region:'NORTH'})">Mi·ªÅn B·∫Øc</button>
    <button class="btn c" onclick="emit('select_region', {region:'CENTRAL'})">Mi·ªÅn Trung</button>
    <button class="btn s" onclick="emit('select_region', {region:'SOUTH'})">Mi·ªÅn Nam</button>
  </div>
</div>

<div id="screenMode" class="screen" style="display:none">
  <h1>Ch·ªçn Ch·∫ø ƒê·ªô</h1>
  <div class="mode-container">
    <div class="mode-card" onclick="emit('enter_mode', {mode:'AUTO'})">
        <div style="font-size:3rem">ü§ñ</div>
        <h3>AI AUTO</h3>
        <p>T·ª± ƒë·ªông 100%</p>
    </div>
    <div class="mode-card" onclick="emit('enter_mode', {mode:'MANUAL'})">
        <div style="font-size:3rem">üéÆ</div>
        <h3>TH·ª¶ C√îNG</h3>
        <p>T·ª± b·∫•m n√∫t</p>
    </div>
  </div>
</div>

<div id="mainApp">
  <div class="card">
    <button class="back-btn" onclick="exit()">‚¨Ö Menu</button>
    <a href="/logout" class="logout-btn">ƒêƒÉng xu·∫•t</a>
    
    {% if role == 'VIEWER' %}
        <div style="text-align:center; font-size:0.8rem; color:#d63031; margin-bottom:10px; font-weight:bold;">
           (Ch·∫ø ƒë·ªô Kh√°ch: B·∫°n ƒëang xem m√†n h√¨nh gi·ªëng Admin nh∆∞ng b·ªã kh√≥a n√∫t b·∫•m)
        </div>
    {% endif %}

    <div class="layout">
      <div style="text-align:center">
        <div class="soil-circle" id="soilBox">
          <span class="soil-num" id="soil">--</span><span>% ƒê·∫§T</span>
        </div>
        <div style="margin-top:20px; font-weight:bold; font-size:1.4rem" id="pumpSt">B∆†M T·∫ÆT</div>
        <div id="warn" style="color:red; font-weight:bold; margin-top:10px; min-height:20px"></div>
        <button onclick="openHistory()" class="hist-btn">üìÖ L·ªãch s·ª≠ & Th·ªëng k√™</button>
      </div>

      <div>
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px">
             <h2 style="margin:0" id="loc">...</h2>
             <button onclick="openCityPopup()" style="background:#eee; border:none; padding:8px 15px; border-radius:20px; cursor:pointer;">‚úé ƒê·ªïi ch·ªó</button>
        </div>
        <div class="stats-grid">
           <div class="stat-box"><span class="stat-val" id="temp">--</span>Nhi·ªát ƒë·ªô</div>
           <div class="stat-box"><span class="stat-val" id="hum">--</span>ƒê·ªô ·∫©m</div>
           <div class="stat-box"><span class="stat-val" id="rain">--</span>M∆∞a</div>
        </div>
        
        <div id="panelAuto">
           <div style="background:#e3f2fd; padding:25px; border-radius:20px; border-left:6px solid #0984e3">
               <h3>ü§ñ AI Control</h3>
               <p>üïí <b>L·∫ßn t∆∞·ªõi k·∫ø:</b> <span id="aiTime" style="color:#d63031; font-weight:bold">...</span></p>
               <p>üí° <i><span id="aiReason">...</span></i></p>
           </div>
        </div>

        <div id="panelManual">
    <div class="manual-grid">
       <button id="btnOn" class="p-btn bon" onclick="pump(true)">B·∫¨T B∆†M</button>
       <button id="btnOff" class="p-btn boff" onclick="pump(false)">T·∫ÆT B∆†M</button>
    </div>
    {% if role == 'VIEWER' %}
       <p style="text-align:center; color:#999; margin-top:10px; font-style:italic">
           (B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô Xem, quy·ªÅn ƒëi·ªÅu khi·ªÉn thu·ªôc v·ªÅ Admin)
       </p>
    {% endif %}
</div>
      </div>
    </div>
  </div>
</div>

<div id="cityPopup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-box">
        <h3>Ch·ªçn T·ªânh Th√†nh</h3>
        <div id="cityList"></div>
        <button onclick="document.getElementById('cityPopup').style.display='none'" style="margin-top:15px; padding:10px;">ƒê√≥ng</button>
    </div>
</div>

<div id="historyPopup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-box" style="width: 600px; max-width: 95%;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <h3 style="margin:0">üìú Nh·∫≠t K√Ω & Th·ªëng K√™</h3>
            <button onclick="document.getElementById('historyPopup').style.display='none'" style="border:none; background:none; font-size:1.2rem; cursor:pointer">‚úñ</button>
        </div>
        
        <div class="filter-bar">
            <input type="date" id="dateInput" class="filter-input" onchange="loadHistory()">
            <select id="actionFilter" class="filter-input" onchange="filterAndRender()">
                <option value="ALL">T·∫•t c·∫£ h√†nh ƒë·ªông</option>
                <option value="PUMP">üí¶ Ch·ªâ xem t∆∞·ªõi n∆∞·ªõc</option>
                <option value="AI">ü§ñ Ch·ªâ xem AI</option>
            </select>
        </div>

        <div id="summaryBox" class="summary-box">
            üí¶ T·ªïng s·ªë l·∫ßn t∆∞·ªõi h√¥m nay: <span id="pumpCount" style="font-size:1.2rem; color:#d63031">0</span> l·∫ßn
        </div>

        <div class="table-container">
            <table class="hist-table">
                <thead><tr><th>Gi·ªù</th><th>H√†nh ƒë·ªông</th><th>Chi ti·∫øt</th></tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
  const BROKER_URL = 'wss://broker.hivemq.com:8884/mqtt';
  const PREFIX = "thaocute_smartgarden/";
  const client = mqtt.connect(BROKER_URL);
  
  // L·∫•y vai tr√≤ t·ª´ Server truy·ªÅn sang
  const USER_ROLE = "{{ role }}"; 

  const REGIONAL_CITIES = {
    'NORTH': ["H√† N·ªôi", "H·∫£i Ph√≤ng", "B·∫Øc Ninh", "H∆∞ng Y√™n", "Nam ƒê·ªãnh", "L√†o Cai"],
    'CENTRAL': ["ƒê√† N·∫µng", "Hu·∫ø", "Nha Trang", "Vinh", "ƒê√† L·∫°t"],
    'SOUTH': ["TP.HCM", "C·∫ßn Th∆°", "V≈©ng T√†u", "B√¨nh D∆∞∆°ng", "C√† Mau"]
  };
  let currentRegion = 'NORTH';
  let rawHistoryData = [];

  client.on('connect', () => { console.log("MQTT Connected"); client.subscribe(PREFIX + 'update'); });
  client.on('message', (topic, msg) => { if (topic === PREFIX + 'update') { updateUI(JSON.parse(msg.toString())); } });

  function updateUI(d) {
      currentRegion = d.region; 
      
      document.getElementById('screenRegion').style.display = (d.step === 0) ? 'flex' : 'none';
      document.getElementById('screenMode').style.display   = (d.step === 1) ? 'flex' : 'none';
      document.getElementById('mainApp').style.display      = (d.step === 2) ? 'block' : 'none';
      
      document.getElementById('loc').innerText = d.location || "...";
      document.getElementById('temp').innerText = d.temp + "¬∞";
      document.getElementById('hum').innerText = d.humidity + "%";
      document.getElementById('rain').innerText = d.rain;
      document.getElementById('soil').innerText = d.soil;
      document.getElementById('warn').innerText = d.warning;

      document.getElementById('panelAuto').style.display = (d.mode === 'AUTO') ? 'block' : 'none';
      document.getElementById('panelManual').style.display = (d.mode === 'MANUAL') ? 'block' : 'none';

      // --- ƒêO·∫†N LOGIC M·ªöI TH√äM V√ÄO ƒê√ÇY ---
      if (d.mode === 'MANUAL') {
          const btnOn = document.getElementById('btnOn');
          const btnOff = document.getElementById('btnOff');
          
          if (USER_ROLE === 'VIEWER') {
              // N·∫øu l√† Kh√°ch: L√†m m·ªù n√∫t v√† kh√¥ng cho b·∫•m
              btnOn.disabled = true;
              btnOff.disabled = true;
              btnOn.style.opacity = "0.5";
              btnOff.style.opacity = "0.5";
              btnOn.style.cursor = "not-allowed";
              btnOff.style.cursor = "not-allowed";
          } else {
              // N·∫øu l√† Admin: Cho ph√©p b·∫•m b√¨nh th∆∞·ªùng
              btnOn.disabled = false;
              btnOff.disabled = false;
              btnOn.style.opacity = "1";
              btnOff.style.opacity = "1";
              btnOn.style.cursor = "pointer";
              btnOff.style.cursor = "pointer";
          }
      }
      // ------------------------------------

      if(d.mode === 'AUTO') {
         document.getElementById('aiTime').innerText = d.ai_timing;
         document.getElementById('aiReason').innerText = d.ai_reason;
      }
      
      const box = document.getElementById('soilBox');
      if(d.soil < 26) { box.classList.add('emergency'); box.style.borderColor='red'; }
      else { box.classList.remove('emergency'); box.style.borderColor='#dfe6e9'; }
      
      const pst = document.getElementById('pumpSt');
      if(d.pump) { pst.innerText = "ƒêANG B∆†M..."; pst.style.color="#00b894"; }
      else { pst.innerText = "M√ÅY B∆†M T·∫ÆT"; pst.style.color="#636e72"; }
  }

  // --- H√ÄM G·ª¨I L·ªÜNH (ƒê√¢y l√† ch·ªët ch·∫∑n quan tr·ªçng) ---
  function emit(ev, d) { 
      // N·∫æU L√Ä KH√ÅCH -> CH·∫∂N L·∫†I V√Ä B√ÅO L·ªñI
      if(USER_ROLE === 'VIEWER') {
          alert("üö´ CH·∫æ ƒê·ªò KH√ÅCH\n\nB·∫°n ch·ªâ ƒë∆∞·ª£c xem th√¥i, kh√¥ng ƒë∆∞·ª£c b·∫•m n√∫t n√†y!\nCh·ªù Admin ƒëi·ªÅu khi·ªÉn nh√©.");
          return; 
      }
      // N·∫æU L√Ä ADMIN -> CHO ƒêI TI·∫æP
      client.publish(PREFIX + 'events', JSON.stringify({event: ev, data: d})); 
  }

  function pump(st) { emit('user_control', {pump: st}); }
  
  function exit() { 
      if(USER_ROLE === 'VIEWER') { 
          alert("Kh√°ch kh√¥ng ƒë∆∞·ª£c tho√°t, ph·∫£i ch·ªù Admin!"); 
          return;
      }
      if(confirm("Tho√°t? B∆°m s·∫Ω T·∫ÆT.")) emit('exit_dashboard', {}); 
  }
  
  function openCityPopup() {
     if(USER_ROLE === 'VIEWER') { alert("Kh√°ch kh√¥ng ƒë∆∞·ª£c ƒë·ªïi ƒë·ªãa ƒëi·ªÉm!"); return; }
     const list = document.getElementById('cityList'); list.innerHTML = "";
     (REGIONAL_CITIES[currentRegion] || []).forEach(c => {
         let btn = document.createElement('button'); btn.className = 'city-opt'; btn.innerText = c;
         btn.onclick = () => { emit('set_city', {city: c}); document.getElementById('cityPopup').style.display = 'none'; };
         list.appendChild(btn);
     });
     document.getElementById('cityPopup').style.display = 'flex';
  }

  function openHistory() { 
      document.getElementById('historyPopup').style.display = 'flex'; 
      document.getElementById('dateInput').valueAsDate = new Date(); 
      loadHistory(); 
  }

  function loadHistory() {
      const date = document.getElementById('dateInput').value; 
      const tbody = document.getElementById('histBody');
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#888">‚è≥ ƒêang t·∫£i...</td></tr>';
      
      fetch('/api/history?date=' + date)
        .then(response => response.json())
        .then(data => {
            rawHistoryData = data || []; 
            filterAndRender();           
        })
        .catch(err => {
            console.error(err);
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:red">L·ªói k·∫øt n·ªëi Server</td></tr>';
        });
  }

  function filterAndRender() {
      const filterType = document.getElementById('actionFilter').value; 
      const tbody = document.getElementById('histBody');
      tbody.innerHTML = "";
      
      let countPump = 0; 
      let filteredData = [];

      rawHistoryData.forEach(item => {
          if (item.action.includes("ON") || item.action.includes("B·∫¨T")) countPump++;
          let shouldShow = false;
          if (filterType === 'ALL') shouldShow = true;
          else if (filterType === 'PUMP' && (item.action.includes('PUMP') || item.action.includes('B∆†M'))) shouldShow = true;
          else if (filterType === 'AI' && item.action.includes('AI')) shouldShow = true;
          if (shouldShow) filteredData.push(item);
      });

      const summaryBox = document.getElementById('summaryBox');
      const pumpCountSpan = document.getElementById('pumpCount');
      if (countPump > 0) {
          summaryBox.style.display = 'block';
          pumpCountSpan.innerText = countPump;
      } else {
          summaryBox.style.display = 'none';
      }

      if (filteredData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px">üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p</td></tr>';
          return;
      }

      filteredData.forEach(item => {
          let badgeClass = 'bg-blue';
          if(item.action.includes('ON') || item.action.includes('B·∫¨T')) badgeClass = 'bg-green';
          else if(item.action.includes('OFF') || item.action.includes('T·∫ÆT')) badgeClass = 'bg-red';
          
          tbody.innerHTML += `<tr><td><span style="font-weight:700; color:#555">${item.time}</span></td>
            <td><span class="badge ${badgeClass}">${item.action}</span></td>
            <td><div style="font-weight:bold; color:#2d3436">${item.detail}</div><div style="font-size:0.8rem; color:#888">ƒê·ªô ·∫©m ƒë·∫•t: ${item.soil}%</div></td></tr>`;
      });
  }
</script>
</body>
</html>

