<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Smart Garden Pro</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2ecc71; --danger: #e74c3c; --ai: #8e44ad; --dark: #34495e; --bg: #f0f2f5; }
        body { margin:0; font-family:'Be Vietnam Pro', sans-serif; background:var(--bg); min-height:100vh; display:flex; justify-content:center; color: #333; }
        
        /* M√ÄN H√åNH SETUP */
        .screen { position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:100; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; box-sizing:border-box; }
        
        /* MAIN APP */
        #mainApp { display:none; width:100%; max-width:480px; padding:15px; box-sizing:border-box; }
        .card { background:white; border-radius:20px; padding:20px; box-shadow:0 8px 20px rgba(0,0,0,0.05); }
        
        /* HEADER */
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .btn-mini { background:#edf2f7; border:none; padding:8px 12px; border-radius:8px; font-weight:600; font-size:12px; cursor:pointer; color:#555; text-decoration:none; }
        
        /* LOCATION */
        .loc-box { display:flex; justify-content:center; align-items:center; gap:8px; margin-bottom:5px; }
        .loc-text { font-size:16px; font-weight:700; color:var(--dark); }
        .btn-edit-loc { background:none; border:none; color:#3498db; cursor:pointer; font-size:14px; text-decoration:underline; padding:0; }

        /* V√íNG TR√íN ƒê·∫§T */
        .soil-wrapper { display:flex; justify-content:center; margin:15px 0; }
        .soil-circle { width:140px; height:140px; border-radius:50%; border:10px solid #eee; display:flex; flex-direction:column; justify-content:center; align-items:center; transition:0.3s; }
        .soil-val { font-size:42px; font-weight:800; color:var(--primary); line-height:1; }
        .soil-lbl { font-size:11px; color:#999; font-weight:600; margin-top:5px; }
        
        /* SENSORS */
        .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin:15px 0; }
        .sensor-box { background:#f8f9fa; padding:10px; border-radius:12px; text-align:center; }
        .s-val { font-size:16px; font-weight:700; color:var(--dark); }
        .s-lbl { font-size:10px; color:#7f8c8d; display:block; text-transform:uppercase; margin-top:3px; }

        /* --- PH√ÇN BI·ªÜT AUTO VS MANUAL --- */
        .control-area { margin-top:20px; min-height: 80px; }
        
        /* Giao di·ªán Manual: N√∫t to */
        .manual-ui button { width:100%; padding:15px; border-radius:12px; border:none; font-weight:bold; color:white; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
        .btn-on { background:var(--primary); }
        .btn-off { background:var(--danger); }

        /* Giao di·ªán Auto: B·∫£ng th√¥ng tin (Kh√¥ng n√∫t) */
        .auto-ui { background:#f3e5f5; border:1px solid #e1bee7; border-radius:12px; padding:15px; text-align:left; position:relative; }
        .auto-badge { position:absolute; top:-10px; right:10px; background:var(--ai); color:white; font-size:10px; padding:4px 8px; border-radius:10px; font-weight:bold; }
        .ai-text { font-size:14px; color:#4a148c; margin-bottom:5px; font-weight:600; }
        .ai-reason { font-size:13px; font-style:italic; color:#6a1b9a; }

        /* KH√ÅCH (VIEWER) */
        .viewer-disabled { opacity:0.6; pointer-events:none; filter:grayscale(80%); position:relative; }
        .viewer-tag { position:absolute; top:-12px; left:50%; transform:translateX(-50%); background:#f1c40f; color:white; font-size:10px; padding:4px 12px; border-radius:20px; font-weight:bold; z-index:10; white-space:nowrap; }

        /* POPUP L·ªäCH S·ª¨ & LIST */
        .popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; align-items:center; justify-content:center; }
        .popup-box { background:white; width:90%; max-width:450px; border-radius:16px; padding:20px; max-height:85vh; display:flex; flex-direction:column; }
        
        /* History Controls */
        .hist-controls { display:flex; gap:10px; margin-bottom:10px; }
        .hist-controls select, .hist-controls input { padding:8px; border:1px solid #ddd; border-radius:8px; font-size:13px; }
        .total-counter { background:#e3f2fd; color:#1565c0; padding:10px; border-radius:8px; text-align:center; font-weight:bold; margin-bottom:10px; font-size:14px; }

        table { width:100%; border-collapse:collapse; font-size:13px; }
        th { text-align:left; color:#888; padding:8px; border-bottom:1px solid #eee; }
        td { padding:8px; border-bottom:1px solid #f5f5f5; }

        /* Button Setup */
        .btn-setup { width:100%; padding:15px; margin:5px 0; border:1px solid #eee; background:white; border-radius:12px; text-align:left; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:10px; }
        .btn-setup:hover { background:#f9f9f9; }
    </style>
</head>
<body>

{% if role != 'VIEWER' %}
<div id="screenRegion" class="screen">
    <h3>üìç Kh√¥ng t√¨m th·∫•y v·ªã tr√≠</h3>
    <p style="color:#777; font-size:13px; margin-top:-10px">Vui l√≤ng ch·ªçn th·ªß c√¥ng</p>
    <button class="btn-setup" onclick="emit('select_region',{region:'NORTH'})"><span>üèØ</span> Mi·ªÅn B·∫Øc</button>
    <button class="btn-setup" onclick="emit('select_region',{region:'CENTRAL'})"><span>üèñÔ∏è</span> Mi·ªÅn Trung</button>
    <button class="btn-setup" onclick="emit('select_region',{region:'SOUTH'})"><span>üå¥</span> Mi·ªÅn Nam</button>
</div>

<div id="screenMode" class="screen" style="display:none">
    <h3>‚öôÔ∏è Ch·ªçn Ch·∫ø ƒê·ªô V·∫≠n H√†nh</h3>
    <button class="btn-setup" style="border:2px solid var(--ai)" onclick="emit('enter_mode',{mode:'AUTO'})">
        <span style="font-size:24px">ü§ñ</span> 
        <div><div>T·ª± ƒê·ªông (AI)</div><div style="font-size:11px;color:#888;font-weight:400">Gemini t·ª± quy·∫øt ƒë·ªãnh b∆°m</div></div>
    </button>
    <button class="btn-setup" style="border:2px solid #95a5a6" onclick="emit('enter_mode',{mode:'MANUAL'})">
        <span style="font-size:24px">üéÆ</span>
        <div><div>Th·ªß C√¥ng</div><div style="font-size:11px;color:#888;font-weight:400">B·∫°n t·ª± b·∫≠t t·∫Øt b∆°m</div></div>
    </button>
</div>
{% endif %}

<div id="mainApp">
    <div class="card">
        <div class="header">
            <div style="display:flex; align-items:center; gap:6px; font-weight:bold; font-size:14px">
                <div id="mqttStatus" style="width:10px;height:10px;border-radius:50%;background:#ccc"></div> Smart Garden
            </div>
            <div>
                {% if role != 'VIEWER' %}
                    <button class="btn-mini" onclick="exit()">Menu Mode</button>
                {% endif %}
                <a href="/logout" class="btn-mini" style="color:red; margin-left:5px">Tho√°t</a>
            </div>
        </div>

        <div class="loc-box">
            <span class="loc-text">üìç <span id="loc">ƒêang t·∫£i...</span></span>
            {% if role != 'VIEWER' %}
                <button class="btn-edit-loc" onclick="openCityPopup()">S·ª≠a</button>
            {% endif %}
        </div>
        <div style="text-align:center; font-size:11px; color:#999; text-transform:uppercase" id="modeLabel">--</div>

        <div class="soil-wrapper">
            <div class="soil-circle" id="soilBox">
                <span class="soil-val" id="soil">--</span>
                <span class="soil-lbl">% ƒê·ªò ·∫®M</span>
            </div>
        </div>
        <div style="text-align:center; font-weight:bold; font-size:14px; color:#555" id="pumpSt">--</div>
        <div style="text-align:center; font-size:13px; color:red; height:18px; font-weight:bold" id="warn"></div>

        <div class="grid-3">
            <div class="sensor-box"><span class="s-val" id="temp">--¬∞</span><span class="s-lbl">Nhi·ªát ƒë·ªô</span></div>
            <div class="sensor-box"><span class="s-val" id="hum">--%</span><span class="s-lbl">Kh√¥ng kh√≠</span></div>
            <div class="sensor-box"><span class="s-val" id="rain">--</span><span class="s-lbl">M∆∞a</span></div>
        </div>

        <div class="control-area">
            
            <div id="panelAuto" class="auto-ui" style="display:none">
                <div class="auto-badge">AI RUNNING</div>
                <div class="ai-text">ü§ñ Gemini ƒëang gi√°m s√°t</div>
                <div class="ai-reason">"<span id="aiReason">H·ªá th·ªëng ƒëang ph√¢n t√≠ch m√¥i tr∆∞·ªùng...</span>"</div>
                <div style="margin-top:5px; font-size:12px; color:#444">K·∫ø ho·∫°ch: <span id="aiTime" style="font-weight:bold">...</span></div>
            </div>

            <div id="panelManual" class="manual-ui" style="display:none">
                {% if role == 'VIEWER' %}
                    <div class="viewer-disabled">
                        <div class="viewer-tag">CH·∫æ ƒê·ªò KH√ÅCH (CH·ªà XEM)</div>
                        <button class="btn-on">B·∫¨T B∆†M T∆Ø·ªöI</button>
                    </div>
                {% else %}
                    <button id="btnOn" class="btn-on" onclick="pump(true)">üíß B·∫¨T M√ÅY B∆†M</button>
                    <button id="btnOff" class="btn-off" onclick="pump(false)" style="display:none">‚õî T·∫ÆT M√ÅY B∆†M</button>
                {% endif %}
            </div>
        </div>

        <button class="btn-mini" style="width:100%; margin-top:20px; padding:12px; background:#e8f0fe; color:#1967d2" onclick="openHistory()">
            üìÖ Xem L·ªãch S·ª≠ & Th·ªëng K√™
        </button>
    </div>
</div>

<div id="cityPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-box">
        <h3>Ch·ªçn V·ªã Tr√≠ Thay Th·∫ø</h3>
        <p style="font-size:12px; color:#666; margin-top:-10px">Do GPS kh√¥ng ch√≠nh x√°c ho·∫∑c b·∫°n mu·ªën ƒë·ªïi v√πng.</p>
        <div id="cityList" style="display:grid; gap:8px; overflow-y:auto; max-height:300px"></div>
        <button class="btn-mini" style="width:100%; margin-top:15px; background:#ddd" onclick="document.getElementById('cityPopup').style.display='none'">ƒê√≥ng</button>
    </div>
</div>

<div id="historyPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-box" style="height:80vh">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
            <h3 style="margin:0">Nh·∫≠t K√Ω</h3>
            <button onclick="document.getElementById('historyPopup').style.display='none'" style="border:none; background:none; font-size:20px">&times;</button>
        </div>

        <div class="total-counter" id="pumpCountText">T·ªïng s·ªë l·∫ßn b∆°m h√¥m nay: 0</div>

        <div class="hist-controls">
            <input type="date" id="dateInput" onchange="loadHistory()" style="flex:1">
            <select id="filterType" onchange="renderHistoryTable()" style="flex:1">
                <option value="ALL">T·∫•t c·∫£</option>
                <option value="AI">ü§ñ AI D·ª± b√°o</option>
                <option value="PUMP">üíß Ho·∫°t ƒë·ªông B∆°m</option>
            </select>
        </div>

        <div style="overflow-y:auto; flex:1">
            <table>
                <thead><tr><th>Gi·ªù</th><th>Lo·∫°i</th><th>Chi ti·∫øt</th></tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const BROKER = 'wss://broker.hivemq.com:8884/mqtt';
    const PREFIX = "thaocute_smartgarden/";
    const ROLE = "{{ role }}";
    const client = mqtt.connect(BROKER, { keepalive: 60, clientId: 'web_'+Math.random().toString(16).substr(2,8) });
    
    // Config
    const CITIES = { 'NORTH': ["H√† N·ªôi","H·∫£i Ph√≤ng","L√†o Cai"], 'CENTRAL': ["ƒê√† N·∫µng","Hu·∫ø","Nha Trang"], 'SOUTH': ["TP.HCM","C·∫ßn Th∆°","C√† Mau"] };
    let currentRegion = 'NORTH';
    let rawHistoryData = []; // L∆∞u d·ªØ li·ªáu th√¥ ƒë·ªÉ l·ªçc

    // --- HI·ªÇN TH·ªä M√ÄN H√åNH ---
    function checkDisplay(step) {
        if (ROLE === 'VIEWER') { document.getElementById('mainApp').style.display='block'; return; }
        ['screenRegion','screenMode','mainApp'].forEach(id => document.getElementById(id).style.display='none');
        if(step===0) document.getElementById('screenRegion').style.display='flex';
        else if(step===1) document.getElementById('screenMode').style.display='flex';
        else if(step===2) document.getElementById('mainApp').style.display='block';
    }
    checkDisplay(0);

    // --- MQTT & UPDATE ---
    client.on('connect', () => {
        document.getElementById('mqttStatus').style.background = '#2ecc71';
        client.subscribe(PREFIX + 'update');
        // Admin: V√†o c√°i l√† t√¨m GPS lu√¥n
        if (ROLE !== 'VIEWER') setTimeout(getRealGPS, 1000);
    });

    client.on('message', (t, m) => updateUI(JSON.parse(m.toString())));

    function updateUI(d) {
        if (!d) return;
        currentRegion = d.region || 'NORTH';
        checkDisplay(d.step);

        document.getElementById('loc').innerText = d.location || "Ch∆∞a r√µ";
        document.getElementById('soil').innerText = d.soil;
        document.getElementById('temp').innerText = d.temp + "¬∞";
        document.getElementById('hum').innerText = d.humidity + "%";
        document.getElementById('rain').innerText = d.rain || "0";
        document.getElementById('warn').innerText = d.warning;
        
        // M√†u v√≤ng tr√≤n
        document.getElementById('soilBox').style.borderColor = (d.soil < 30) ? "#e74c3c" : "#2ecc71";

        // Tr·∫°ng th√°i B∆°m
        const pSt = document.getElementById('pumpSt');
        if (d.pump) {
            pSt.innerText = "ƒêANG B∆†M N∆Ø·ªöC..."; pSt.style.color = "#2980b9";
            document.getElementById('btnOn').style.display='none'; document.getElementById('btnOff').style.display='flex';
        } else {
            pSt.innerText = "M√ÅY B∆†M ƒêANG T·∫ÆT"; pSt.style.color = "#555";
            document.getElementById('btnOn').style.display='flex'; document.getElementById('btnOff').style.display='none';
        }

        // --- X·ª¨ L√ù KH√ÅC BI·ªÜT AUTO / MANUAL ---
        // Mode Label Header
        document.getElementById('modeLabel').innerText = (d.mode === 'AUTO') ? "MODE: T·ª∞ ƒê·ªòNG (AI)" : "MODE: TH·ª¶ C√îNG";

        const pAuto = document.getElementById('panelAuto');
        const pManual = document.getElementById('panelManual');

        if (ROLE === 'VIEWER') {
            // Kh√°ch lu√¥n th·∫•y Manual (b·ªã m·ªù)
            pAuto.style.display = 'none';
            pManual.style.display = 'block';
        } else {
            if (d.mode === 'AUTO') {
                // Auto: Hi·ªán b·∫£ng AI, ·∫®n ho√†n to√†n b·∫£ng n√∫t b·∫•m
                pAuto.style.display = 'block';
                pManual.style.display = 'none';
                document.getElementById('aiReason').innerText = d.ai_reason || "H·ªá th·ªëng ·ªïn ƒë·ªãnh";
                document.getElementById('aiTime').innerText = d.ai_timing || "...";
            } else {
                // Manual: Hi·ªán n√∫t b·∫•m, ·∫®n b·∫£ng AI
                pAuto.style.display = 'none';
                pManual.style.display = 'block';
            }
        }
    }

    function emit(ev, data) { if (ROLE === 'VIEWER') return; client.publish(PREFIX + 'events', JSON.stringify({event: ev, data: data || {}})); }
    function pump(st) { emit('user_control', {pump: st}); }
    function exit() { if(confirm("V·ªÅ menu ch·ªçn ch·∫ø ƒë·ªô?")) emit('exit_dashboard', {}); }

    // --- GPS & LOCATION FALLBACK ---
    function getRealGPS() {
        if (ROLE === 'VIEWER') return;
        document.getElementById('loc').innerText = "ƒêang qu√©t GPS...";
        if (!navigator.geolocation) { fallbackIP(); return; }

        navigator.geolocation.getCurrentPosition(
            (p) => emit('set_gps', {lat: p.coords.latitude, lon: p.coords.longitude}),
            () => { console.log("GPS Blocked"); fallbackIP(); },
            { timeout: 7000 }
        );
    }

    function fallbackIP() {
        document.getElementById('loc').innerText = "ƒêang qu√©t IP...";
        fetch('https://ipapi.co/json/')
            .then(r => r.json())
            .then(d => {
                if(d.latitude) {
                    emit('set_gps', {lat: d.latitude, lon: d.longitude});
                    document.getElementById('loc').innerText = d.city + " (IP)";
                } else throw "IP Error";
            })
            .catch(() => {
                // FAIL C·∫¢ GPS L·∫™N IP -> M·ªû LU√îN DANH S√ÅCH CH·ªåN
                document.getElementById('loc').innerText = "L·ªói v·ªã tr√≠!";
                openCityPopup(); 
            });
    }

    function openCityPopup() {
        if (ROLE === 'VIEWER') return;
        const list = document.getElementById('cityList'); list.innerHTML = "";
        
        // T·∫°o danh s√°ch t·∫•t c·∫£ c√°c mi·ªÅn ƒë·ªÉ ng∆∞·ªùi d√πng d·ªÖ ch·ªçn l·∫°i
        // Ho·∫∑c ch·ªâ hi·ªÉn th·ªã mi·ªÅn hi·ªán t·∫°i: const cities = CITIES[currentRegion] || [];
        // ·ªû ƒë√¢y m√¨nh hi·ªÉn th·ªã g·ªôp l·∫°i cho d·ªÖ t√¨m n·∫øu user ch·ªçn sai mi·ªÅn t·ª´ ƒë·∫ßu
        const allCities = [...CITIES['NORTH'], ...CITIES['CENTRAL'], ...CITIES['SOUTH']];
        
        allCities.forEach(c => {
            let b = document.createElement('button');
            b.className = "btn-mini"; b.style.width="100%"; b.style.padding="12px"; b.style.marginBottom="5px"; 
            b.style.textAlign="left"; b.style.background="#f8f9fa";
            b.innerText = "üìç " + c;
            b.onclick = () => { 
                emit('set_city', {city: c}); 
                document.getElementById('cityPopup').style.display='none'; 
                // C·∫≠p nh·∫≠t l·∫°i UI t·∫°m th·ªùi
                document.getElementById('loc').innerText = c;
            };
            list.appendChild(b);
        });
        document.getElementById('cityPopup').style.display = 'flex';
    }

    // --- L·ªäCH S·ª¨ N√ÇNG CAO ---
    function openHistory() {
        document.getElementById('historyPopup').style.display = 'flex';
        document.getElementById('dateInput').valueAsDate = new Date();
        loadHistory();
    }

    function loadHistory() {
        const d = document.getElementById('dateInput').value;
        const tbody = document.getElementById('histBody');
        tbody.innerHTML = "<tr><td colspan='3' style='text-align:center'>ƒêang t·∫£i...</td></tr>";

        fetch('/api/history?date=' + d)
            .then(r => r.json())
            .then(data => {
                rawHistoryData = data || []; // L∆∞u d·ªØ li·ªáu g·ªëc
                renderHistoryTable(); // V·∫Ω b·∫£ng
            })
            .catch(() => tbody.innerHTML = "<tr><td colspan='3'>L·ªói t·∫£i d·ªØ li·ªáu</td></tr>");
    }

    function renderHistoryTable() {
        const tbody = document.getElementById('histBody');
        const filter = document.getElementById('filterType').value;
        tbody.innerHTML = "";

        if (rawHistoryData.length === 0) {
            tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;color:#999'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>";
            document.getElementById('pumpCountText').innerText = "T·ªïng s·ªë l·∫ßn b∆°m: 0";
            return;
        }

        // 1. T√≠nh t·ªïng s·ªë l·∫ßn B∆†M trong ng√†y (b·∫•t k·ªÉ filter ƒëang ch·ªçn l√† g√¨)
        const totalPump = rawHistoryData.filter(i => i.action.includes('ON') || i.action.includes('B·∫¨T') || i.action.includes('PUMP')).length;
        document.getElementById('pumpCountText').innerText = `T·ªïng s·ªë l·∫ßn b∆°m h√¥m nay: ${totalPump}`;

        // 2. L·ªçc d·ªØ li·ªáu hi·ªÉn th·ªã theo Dropdown
        const filteredData = rawHistoryData.filter(i => {
            if (filter === 'ALL') return true;
            if (filter === 'AI') return i.action.includes('AI') || i.detail.includes('AI') || i.action.includes('AUTO');
            if (filter === 'PUMP') return i.action.includes('ON') || i.action.includes('OFF') || i.action.includes('B·∫¨T') || i.action.includes('T·∫ÆT');
            return true;
        });

        if (filteredData.length === 0) {
            tbody.innerHTML = "<tr><td colspan='3' style='text-align:center'>Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p</td></tr>";
            return;
        }

        filteredData.forEach(i => {
            // T√¥ m√†u cho ƒë·∫πp
            let color = '#333';
            let icon = '';
            if (i.action.includes('ON') || i.action.includes('B·∫¨T')) { color = '#27ae60'; icon='üíß'; } // Xanh l√°
            else if (i.action.includes('OFF') || i.action.includes('T·∫ÆT')) { color = '#c0392b'; icon='‚õî'; } // ƒê·ªè
            else if (i.action.includes('AI') || i.action.includes('AUTO')) { color = '#8e44ad'; icon='ü§ñ'; } // T√≠m

            tbody.innerHTML += `<tr>
                <td style="color:#666">${i.time}</td>
                <td style="color:${color};font-weight:bold">${icon} ${i.action}</td>
                <td>${i.detail}</td>
            </tr>`;
        });
    }
</script>
</body>
</html>
