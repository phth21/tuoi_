<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Garden Monitor</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2ecc71; --danger: #e74c3c; --dark: #2c3e50; --light: #ecf0f1; }
        body { margin:0; font-family:'Roboto',sans-serif; background:#f0f2f5; min-height:100vh; color:#333; display:flex; justify-content:center; }
        .screen { position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:100; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        #mainApp { display:none; width:100%; max-width:480px; padding:15px; box-sizing:border-box; }
        .card { background:white; border-radius:16px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.1); margin-bottom:15px; }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; font-size:14px; }
        .btn-simple { background:#e4e6eb; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
        .btn-simple:hover { background:#d8dadf; }
        .viewer-badge { background:#f39c12; color:white; padding:5px 10px; border-radius:20px; font-size:12px; font-weight:bold; }
        .location-row { font-size:16px; font-weight:600; margin-bottom:15px; text-align:center; }
        .location-btns { display:flex; gap:8px; justify-content:center; margin-top:8px; }
        .soil-circle { width:160px; height:160px; margin:20px auto; border-radius:50%; border:14px solid #e4e6eb; background:white; display:flex; flex-direction:column; justify-content:center; align-items:center; transition:0.3s; }
        .soil-value { font-size:44px; font-weight:700; color:var(--primary); }
        .soil-label { font-size:13px; color:#777; }
        .emergency { border-color:var(--danger)!important; }
        .pump-status { text-align:center; font-size:16px; font-weight:600; margin:10px 0; }
        .warning { text-align:center; color:var(--danger); font-weight:bold; min-height:20px; font-size:14px; }
        .sensor-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin:20px 0; }
        .sensor-item { background:#f8f9fa; padding:14px; border-radius:12px; text-align:center; }
        .sensor-val { font-size:18px; font-weight:700; color:#333; }
        .sensor-name { font-size:12px; color:#666; margin-top:4px; display:block; }
        .control-area { margin:20px 0; position:relative; }
        .viewer-disabled { opacity:0.5; pointer-events:none; }
        .viewer-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:transparent; }
        .btn-pump { width:100%; padding:16px; border:none; border-radius:12px; font-size:16px; font-weight:bold; color:white; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; margin:8px 0; }
        .btn-on { background:var(--primary); }
        .btn-off { background:var(--danger); }
        .history-btn { width:100%; padding:12px; background:#3498db; color:white; border:none; border-radius:12px; font-weight:600; cursor:pointer; }
        .popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:200; justify-content:center; align-items:center; }
        .popup-inner { background:white; width:90%; max-width:500px; border-radius:16px; padding:20px; max-height:85vh; overflow-y:auto; }
        .stats { text-align:center; margin:15px 0; font-size:14px; color:#555; }
    </style>
</head>
<body>

{% if role != 'VIEWER' %}
<div id="screenRegion" class="screen"> 
    <h2>Ch·ªçn Khu V·ª±c</h2>
    <button class="btn-simple" style="padding:15px 30px; font-size:16px; margin:10px;" onclick="emit('select_region',{region:'NORTH'})">Mi·ªÅn B·∫Øc</button>
    <button class="btn-simple" style="padding:15px 30px; font-size:16px; margin:10px; background:#3498db" onclick="emit('select_region',{region:'CENTRAL'})">Mi·ªÅn Trung</button>
    <button class="btn-simple" style="padding:15px 30px; font-size:16px; margin:10px; background:#e67e22" onclick="emit('select_region',{region:'SOUTH'})">Mi·ªÅn Nam</button>
</div>
<div id="screenMode" class="screen" style="display:none">
    <h2>Ch·ªçn Ch·∫ø ƒê·ªô</h2>
    <button class="btn-simple" style="padding:20px 40px; font-size:18px; margin:15px; background:var(--primary)" onclick="emit('enter_mode',{mode:'AUTO'})">ü§ñ T·ª∞ ƒê·ªòNG</button>
    <button class="btn-simple" style="padding:20px 40px; font-size:18px; margin:15px; background:#95a5a6" onclick="emit('enter_mode',{mode:'MANUAL'})">üéÆ TH·ª¶ C√îNG</button>
</div>
{% endif %}

<div id="mainApp">
    <div class="card">
        <div class="header">
            <div id="mqttStatus" style="width:10px;height:10px;border-radius:50%;background:#ccc;"></div>
            <div>
                {% if role == 'VIEWER' %}
                    <span class="viewer-badge">üëÅÔ∏è KH√ÅCH XEM</span>
                {% else %}
                    <button class="btn-simple" onclick="exit()">Menu</button>
                {% endif %}
                <a href="/logout" class="btn-simple" style="color:red; margin-left:5px">Tho√°t</a>
            </div>
        </div>

        <div class="location-row">
            üìç <span id="loc">ƒêang ƒë·ªãnh v·ªã...</span>
            {% if role != 'VIEWER' %}
            <div class="location-btns">
                <button class="btn-simple" onclick="getRealGPS()">üéØ GPS</button>
                <button class="btn-simple" id="cityListBtn" onclick="openCityPopup()" style="display:none">List</button>
            </div>
            {% endif %}
        </div>

        <div class="soil-circle" id="soilBox">
            <div class="soil-value" id="soil">--</div>
            <div class="soil-label">% ƒê·ªò ·∫®M ƒê·∫§T</div>
        </div>
        <div class="warning" id="warn"></div>
        <div class="pump-status" id="pumpSt">TR·∫†NG TH√ÅI: T·∫ÆT</div>

        <div class="sensor-grid">
            <div class="sensor-item"><span class="sensor-val" id="temp">--¬∞</span><span class="sensor-name">Nhi·ªát ƒë·ªô</span></div>
            <div class="sensor-item"><span class="sensor-val" id="hum">--%</span><span class="sensor-name">ƒê·ªô ·∫©m KK</span></div>
            <div class="sensor-item"><span class="sensor-val" id="rain">--</span><span class="sensor-name">M∆∞a (mm/h)</span></div>
        </div>

        <div class="control-area {% if role == 'VIEWER' %}viewer-disabled{% endif %}">
            {% if role == 'VIEWER' %}<div class="viewer-overlay"></div>{% endif %}
            <button class="btn-pump btn-on" onclick="pump(true)">üíß B·∫¨T B∆†M</button>
            <button class="btn-pump btn-off" onclick="pump(false)">‚õî T·∫ÆT B∆†M</button>
        </div>

        <button class="history-btn" onclick="openHistory()">üìÖ Xem L·ªãch S·ª≠</button>
        <div class="stats" id="pumpCountToday">T·ªïng l·∫ßn b∆°m h√¥m nay: 0</div>
    </div>
</div>

{% if role != 'VIEWER' %}
<div id="cityPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-inner">
        <h3>Ch·ªçn Th√†nh Ph·ªë</h3>
        <div id="cityList" style="display:grid; gap:8px;"></div>
        <button class="btn-simple" style="width:100%; margin-top:15px" onclick="document.getElementById('cityPopup').style.display='none'">ƒê√≥ng</button>
    </div>
</div>
{% endif %}

<div id="historyPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-inner">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center">
            <h3>Nh·∫≠t K√Ω Ho·∫°t ƒê·ªông</h3>
            <input type="date" id="dateInput" onchange="loadHistory()" style="padding:6px; border-radius:6px; border:1px solid #ddd">
        </div>
        <div style="overflow-x:auto; max-height:60vh">
            <table style="width:100%; border-collapse:collapse; font-size:14px">
                <thead style="background:#f8f9fa"><tr><th style="text-align:left;padding:8px">Gi·ªù</th><th style="text-align:left;padding:8px">H√†nh ƒë·ªông</th><th style="text-align:left;padding:8px">Chi ti·∫øt</th></tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
        <button class="btn-simple" style="width:100%; margin-top:15px" onclick="document.getElementById('historyPopup').style.display='none'">ƒê√≥ng</button>
    </div>
</div>

<script>
    const BROKER_URL = 'wss://broker.hivemq.com:8884/mqtt';
    const PREFIX = "thaocute_smartgarden/";
    const USER_ROLE = "{{ role }}";
    const client = mqtt.connect(BROKER_URL, { keepalive: 60, clientId: 'web_'+Math.random().toString(16).substr(2,8) });
    const CITIES = { 'NORTH': ["H√† N·ªôi","H·∫£i Ph√≤ng","L√†o Cai"], 'CENTRAL': ["ƒê√† N·∫µng","Hu·∫ø","Nha Trang"], 'SOUTH': ["TP.HCM","C·∫ßn Th∆°","C√† Mau"] };
    let currentRegion = 'NORTH';
    let todayPumpCount = 0;

    function checkDisplay(step) {
        if (USER_ROLE === 'VIEWER') {
            document.getElementById('mainApp').style.display = 'block';
            return;
        }
        document.getElementById('screenRegion').style.display = (step === 0) ? 'flex' : 'none';
        document.getElementById('screenMode').style.display = (step === 1) ? 'flex' : 'none';
        document.getElementById('mainApp').style.display = (step === 2) ? 'block' : 'none';
    }
    checkDisplay(0);

    client.on('connect', () => {
        document.getElementById('mqttStatus').style.background = '#2ecc71';
        client.subscribe(PREFIX + 'update');
        if (USER_ROLE !== 'VIEWER' && navigator.geolocation) {
            setTimeout(() => getRealGPS(), 1000); // T·ª± ƒë·ªông GPS khi load
        }
    });

    client.on('message', (topic, msg) => {
        if (topic === PREFIX + 'update') updateUI(JSON.parse(msg.toString()));
    });

    function updateUI(d) {
        if (!d) return;
        currentRegion = d.region;
        checkDisplay(d.step);

        document.getElementById('loc').innerText = d.location || "Ch∆∞a x√°c ƒë·ªãnh";
        document.getElementById('soil').innerText = d.soil;
        document.getElementById('temp').innerText = d.temp + "¬∞";
        document.getElementById('hum').innerText = d.humidity + "%";
        document.getElementById('rain').innerText = d.rain || "0";
        document.getElementById('warn').innerText = d.warning;

        const soilBox = document.getElementById('soilBox');
        soilBox.classList.toggle('emergency', parseInt(d.soil) < 26);

        const pumpSt = document.getElementById('pumpSt');
        if (d.pump) {
            pumpSt.innerText = "üí¶ ƒêANG B∆†M N∆Ø·ªöC";
            pumpSt.style.color = "#2980b9";
        } else {
            pumpSt.innerText = "M√ÅY B∆†M T·∫ÆT";
            pumpSt.style.color = "#7f8c8d";
        }

        // Kh√°ch kh√¥ng th·∫•y AI ‚Üí lu√¥n hi·ªán panel Manual (ƒë√£ disable)
    }

    function emit(ev, data) {
        if (USER_ROLE === 'VIEWER') return;
        client.publish(PREFIX + 'events', JSON.stringify({event: ev, data: data || {}}));
    }
    function pump(st) { emit('user_control', {pump: st}); }
    function exit() { if(confirm("V·ªÅ menu?")) emit('exit_dashboard', {}); }

    function getRealGPS() {
        if (USER_ROLE === 'VIEWER') return;
        document.getElementById('loc').innerText = "ƒêang ƒë·ªãnh v·ªã GPS...";
        if (!navigator.geolocation) return fallbackIP();
        
        navigator.geolocation.getCurrentPosition(
            p => {
                emit('set_gps', {lat: p.coords.latitude, lon: p.coords.longitude});
                document.getElementById('cityListBtn').style.display = 'none';
            },
            err => {
                console.log("GPS fail ‚Üí d√πng IP");
                fallbackIP();
            },
            { timeout: 8000 }
        );
    }

    function fallbackIP() {
        document.getElementById('loc').innerText = "D√πng IP ƒë·ªãnh v·ªã...";
        fetch('https://ipapi.co/json/')
            .then(r => r.json())
            .then(data => {
                if (data.latitude) {
                    emit('set_gps', {lat: data.latitude, lon: data.longitude});
                    document.getElementById('loc').innerText = `${data.city || 'Vi·ªát Nam'} (IP)`;
                } else throw "";
            })
            .catch(() => {
                document.getElementById('loc').innerText = "Kh√¥ng ƒë·ªãnh v·ªã ƒë∆∞·ª£c";
                document.getElementById('cityListBtn').style.display = 'block';
            });
    }

    function openCityPopup() {
        const list = document.getElementById('cityList'); list.innerHTML = "";
        (CITIES[currentRegion] || []).forEach(c => {
            let btn = document.createElement('button');
            btn.className = "btn-simple"; btn.style.width = "100%"; btn.innerText = c;
            btn.onclick = () => { emit('set_city', {city: c}); document.getElementById('cityPopup').style.display='none'; };
            list.appendChild(btn);
        });
        document.getElementById('cityPopup').style.display = 'flex';
    }

    function openHistory() {
        document.getElementById('historyPopup').style.display = 'flex';
        document.getElementById('dateInput').valueAsDate = new Date();
        loadHistory();
    }

    function loadHistory() {
        const date = document.getElementById('dateInput').value;
        fetch('/api/history?date=' + date)
            .then(r => r.json())
            .then(data => {
                const tbody = document.getElementById('histBody'); tbody.innerHTML = "";
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                    document.getElementById('pumpCountToday').innerText = "T·ªïng l·∫ßn b∆°m h√¥m nay: 0";
                    return;
                }
                todayPumpCount = data.filter(i => i.action.includes("PUMP_ON") || i.detail.includes("B·∫¨T")).length;
                document.getElementById('pumpCountToday').innerText = `T·ªïng l·∫ßn b∆°m h√¥m nay: ${todayPumpCount}`;

                data.forEach(i => {
                    const color = i.action.includes('ON') || i.action.includes('B·∫¨T') ? '#27ae60' : '#2980b9';
                    tbody.innerHTML += `<tr><td>${i.time}</td><td style="color:${color};font-weight:bold">${i.action}</td><td>${i.detail || ''}</td></tr>`;
                });
            });
    }
</script>
</body>
</html>
