<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Smart Garden Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- C·∫§U H√åNH GIAO DI·ªÜN COMPACT --- */
        body { font-family: "Segoe UI", sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; min-height: 100vh; color: #333; overflow-x: hidden; }
        
        /* M√†n h√¨nh ch·ªù/Setup */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
        
        /* Khung ch√≠nh */
        #mainApp { display: none; width: 100%; max-width: 500px; padding: 10px; box-sizing: border-box; }
        
        .card { background: white; border-radius: 16px; padding: 15px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        
        /* Header g·ªçn */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-mini { background: #e4e6eb; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; text-decoration: none; color: #333; display: inline-block;}
        
        /* V√≤ng tr√≤n ƒë·ªô ·∫©m (Thu nh·ªè) */
        .soil-wrapper { text-align: center; margin: 10px 0; position: relative; }
        .soil-circle { 
            width: 140px; height: 140px; margin: 0 auto; border-radius: 50%; 
            border: 10px solid #eee; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; transition: border-color 0.5s; 
        }
        .soil-value { font-size: 42px; font-weight: 700; color: #2ecc71; line-height: 1; }
        .soil-label { font-size: 11px; color: #888; margin-top: 2px; }
        .pump-status { font-size: 13px; font-weight: 700; color: #555; margin-top: 8px; text-transform: uppercase; }

        /* C·∫£m bi·∫øn (Grid 3 c·ªôt) */
        .sensor-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        .sensor-box { background: #f8f9fa; padding: 10px 5px; border-radius: 10px; text-align: center; }
        .sensor-val { font-size: 18px; font-weight: 700; color: #333; display: block; }
        .sensor-name { font-size: 11px; color: #666; }

        /* PANEL ƒêI·ªÄU KHI·ªÇN & AI */
        .control-area { margin-top: 15px; }
        
        /* Manual Mode Buttons */
        .btn-pump { width: 100%; padding: 14px; border-radius: 10px; border: none; font-size: 15px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s;}
        .on { background: #2ecc71; box-shadow: 0 4px 6px rgba(46, 204, 113, 0.3); }
        .off { background: #e74c3c; box-shadow: 0 4px 6px rgba(231, 76, 60, 0.3); }
        .btn-pump:active { transform: scale(0.98); }

        /* AI Mode Box */
        .ai-box { background: #e8f5e9; padding: 12px; border-radius: 10px; border-left: 4px solid #2ecc71; font-size: 13px; }
        .ai-time { font-weight: bold; color: #d35400; font-size: 14px; }

        /* KH√ÅCH (Viewer) -> Disable Manual Panel */
        .viewer-disabled { 
            opacity: 0.6; pointer-events: none; filter: grayscale(90%); position: relative; 
        }
        .viewer-badge {
            position: absolute; top: -12px; right: 0; left: 0; margin: auto; width: fit-content;
            background: #f39c12; color: white; font-size: 10px; padding: 4px 10px; 
            border-radius: 20px; font-weight: bold; z-index: 10;
        }

        /* Chart & Popup */
        #chartContainer { height: 100px; margin-top: 15px; width: 100%; }
        .popup { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; }
        .popup-inner { background: white; padding: 20px; border-radius: 16px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* L·ªãch s·ª≠ Table */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; color: #888; padding: 8px; font-size: 11px; text-transform: uppercase; }
        td { padding: 8px; border-bottom: 1px solid #f0f0f0; }

        /* Setup Buttons */
        .btn-setup { width: 220px; padding: 15px; font-size: 16px; border: none; border-radius: 12px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; text-align: left; display: flex; align-items: center; gap: 15px; font-weight: 600;}
        .btn-setup:hover { background: #f9fafb; }
    </style>
</head>
<body>

<div id="screenLoading" class="screen" style="display:none">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #2ecc71; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    <div>ƒêang ƒë·ªãnh v·ªã t·ª± ƒë·ªông...</div>
    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
</div>

<div id="screenRegion" class="screen" style="display:none">
    <h3>Kh√¥ng t√¨m th·∫•y GPS üõ∞Ô∏è</h3>
    <p style="color:#666; font-size:13px; margin-top:-10px">Vui l√≤ng ch·ªçn th·ªß c√¥ng</p>
    <button class="btn-setup" onclick="emit('select_region', {region:'NORTH'})"><span>üèØ</span> Mi·ªÅn B·∫Øc</button>
    <button class="btn-setup" onclick="emit('select_region', {region:'CENTRAL'})"><span>üèñÔ∏è</span> Mi·ªÅn Trung</button>
    <button class="btn-setup" onclick="emit('select_region', {region:'SOUTH'})"><span>üå¥</span> Mi·ªÅn Nam</button>
</div>

<div id="screenMode" class="screen" style="display:none">
    <h3>Ch·ªçn Ch·∫ø ƒê·ªô V·∫≠n H√†nh</h3>
    <button class="btn-setup" onclick="emit('enter_mode', {mode:'AUTO'})">
        <span style="font-size:24px">ü§ñ</span> 
        <div><div>T·ª± ƒê·ªông (AI)</div><div style="font-size:12px;color:#888;font-weight:400">Gemini t·ª± quy·∫øt ƒë·ªãnh</div></div>
    </button>
    <button class="btn-setup" onclick="emit('enter_mode', {mode:'MANUAL'})">
        <span style="font-size:24px">üéÆ</span>
        <div><div>Th·ªß C√¥ng</div><div style="font-size:12px;color:#888;font-weight:400">B·∫°n t·ª± b·∫≠t t·∫Øt b∆°m</div></div>
    </button>
</div>

<div id="mainApp">
    <div class="card">
        <div class="header-row">
            <div style="display:flex; align-items:center; gap:5px; font-weight:700; font-size:14px">
                <div id="mqttStatus" style="width:8px; height:8px; border-radius:50%; background:#ccc;"></div> Smart Garden
            </div>
            <div>
                {% if role != 'VIEWER' %}
                    <button class="btn-mini" onclick="exit()">Menu</button>
                    <button class="btn-mini" onclick="openCityPopup()">S·ª≠a VT</button>
                {% endif %}
                <a href="/logout" class="btn-mini" style="color:#e74c3c; background:none;">Tho√°t</a>
            </div>
        </div>

        <div style="text-align:center; margin-bottom:10px">
            <div style="font-size:16px; font-weight:700; color:#333">üìç <span id="loc">...</span></div>
            <div style="font-size:11px; color:#888; text-transform:uppercase; font-weight:600" id="modeLabel">--</div>
        </div>

        <div class="soil-wrapper">
            <div class="soil-circle" id="soilBox">
                <span class="soil-value" id="soil">--</span>
                <span class="soil-label">% ƒê·ªò ·∫®M</span>
            </div>
            <div class="pump-status" id="pumpSt">--</div>
        </div>

        <div class="sensor-row">
            <div class="sensor-box"><span class="sensor-val" id="temp">--¬∞</span><span class="sensor-name">Nhi·ªát ƒë·ªô</span></div>
            <div class="sensor-box"><span class="sensor-val" id="hum">--%</span><span class="sensor-name">Kh√¥ng kh√≠</span></div>
            <div class="sensor-box"><span class="sensor-val" id="rain">--</span><span class="sensor-name">M∆∞a</span></div>
        </div>

        <div class="control-area">
            
            <div id="panelAuto" style="display:none;">
                <div class="ai-box">
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px; color:#27ae60; font-weight:bold">
                        <span>ü§ñ</span> GEMINI AI ANALYSIS
                    </div>
                    <div>K·∫ø ho·∫°ch: <span class="ai-time" id="aiTime">ƒêang t√≠nh to√°n...</span></div>
                    <div style="margin-top:4px; font-style:italic; color:#555">"<span id="aiReason">...</span>"</div>
                </div>
            </div>

            <div id="panelManual" style="display:none;">
                {% if role == 'VIEWER' %}
                    <div class="viewer-disabled">
                        <div class="viewer-badge">CH·∫æ ƒê·ªò KH√ÅCH (CH·ªà XEM)</div>
                        <button class="btn-pump on">B·∫¨T B∆†M T∆Ø·ªöI</button>
                    </div>
                {% else %}
                    <button id="btnOn" class="btn-pump on" onclick="pump(true)"><span>üåä</span> B·∫¨T B∆†M T∆Ø·ªöI</button>
                    <button id="btnOff" class="btn-pump off" onclick="pump(false)" style="display:none"><span>üõë</span> T·∫ÆT M√ÅY B∆†M</button>
                {% endif %}
            </div>
        </div>

        <div id="chartContainer"><canvas id="myChart"></canvas></div>
        <button class="btn-mini" style="width:100%; margin-top:10px; padding:10px; background:#f8f9fa; color:#666" onclick="openHistory()">üìñ Xem Nh·∫≠t K√Ω Ho·∫°t ƒê·ªông</button>
    </div>
</div>

<div id="cityPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-inner">
        <h3>Ch·ªçn V·ªã Tr√≠</h3>
        <div id="cityList" style="display:grid; gap:8px;"></div>
        <button class="btn-mini" style="width:100%; margin-top:15px; padding:10px" onclick="document.getElementById('cityPopup').style.display='none'">ƒê√≥ng</button>
    </div>
</div>

<div id="historyPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-inner" style="height:80vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <h3 style="margin:0">Nh·∫≠t K√Ω</h3>
            <button onclick="document.getElementById('historyPopup').style.display='none'" style="border:none;background:none;font-size:20px">&times;</button>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:10px">
            <input type="date" id="dateInput" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:8px">
            <button class="btn-mini" style="background:#3b82f6; color:white" onclick="loadHistory()">L·ªçc</button>
        </div>
        <div style="flex:1; overflow-y:auto">
            <table>
                <thead><tr><th>Gi·ªù</th><th>H√†nh ƒë·ªông</th><th>Chi ti·∫øt</th></tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const BROKER_URL = 'wss://broker.hivemq.com:8884/mqtt';
    const PREFIX = "thaocute_smartgarden/";
    const ROLE = "{{ role }}"; 
    
    const client = mqtt.connect(BROKER_URL, { keepalive: 60, clientId: 'Web_' + Math.random().toString(16).substr(2, 8), clean: true });
    
    // --- KH·ªûI T·∫†O ---
    function init() {
        if (ROLE === 'VIEWER') {
            // Kh√°ch: V√†o th·∫≥ng Dashboard
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('panelManual').style.display = 'block'; // Lu√¥n hi·ªán panel manual
            return;
        }

        // Admin: Th·ª≠ Auto Location tr∆∞·ªõc
        document.getElementById('screenLoading').style.display = 'flex';
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    // C√≥ GPS -> L·∫•y t√™n TP
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`;
                    fetch(url).then(r=>r.json()).then(data => {
                        let city = data.address.city || data.address.state || "H√† N·ªôi";
                        emit('auto_locate', {city: city});
                        // Xong th√¨ nh·∫£y sang ch·ªçn Mode
                        showScreen('screenMode');
                    }).catch(() => showScreen('screenRegion')); // L·ªói API -> Ch·ªçn tay
                },
                () => showScreen('screenRegion') // T·ª´ ch·ªëi GPS -> Ch·ªçn tay
            );
        } else {
            showScreen('screenRegion');
        }
    }

    function showScreen(id) {
        // ·∫®n h·∫øt c√°c m√†n h√¨nh setup
        document.getElementById('screenLoading').style.display = 'none';
        document.getElementById('screenRegion').style.display = 'none';
        document.getElementById('screenMode').style.display = 'none';
        document.getElementById(id).style.display = 'flex';
    }

    window.onload = init;

    // --- MQTT & UPDATE UI ---
    client.on('connect', () => { client.subscribe(PREFIX + 'update'); document.getElementById('mqttStatus').style.background = "#2ecc71"; });
    client.on('message', (t, m) => updateUI(JSON.parse(m.toString())));

    let myChart = new Chart(document.getElementById('myChart'), {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: '#2ecc71', borderWidth: 2, tension: 0.4, pointRadius: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: {display:false}, y: {display:false} }, plugins: {legend: {display:false}} }
    });

    function updateUI(d) {
        if (!d) return;
        
        // Admin: ƒê·ªìng b·ªô m√†n h√¨nh theo server (n·∫øu ƒë√£ qua b∆∞·ªõc setup)
        if (ROLE !== 'VIEWER' && d.step === 2) {
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('screenMode').style.display = 'none';
        }

        // ƒêi·ªÅn d·ªØ li·ªáu
        document.getElementById('loc').innerText = d.location;
        document.getElementById('modeLabel').innerText = (d.mode === 'AUTO') ? "AUTO MODE" : "MANUAL MODE";
        document.getElementById('temp').innerText = d.temp + "¬∞";
        document.getElementById('hum').innerText = d.humidity + "%";
        document.getElementById('rain').innerText = d.rain;
        document.getElementById('soil').innerText = d.soil;
        document.getElementById('soilBox').style.borderColor = (d.soil < 30) ? "#e74c3c" : "#2ecc71";

        // Logic hi·ªÉn th·ªã Panel ƒêi·ªÅu khi·ªÉn
        const pAuto = document.getElementById('panelAuto');
        const pManual = document.getElementById('panelManual');
        const pumpSt = document.getElementById('pumpSt');

        // Tr·∫°ng th√°i B∆°m (Text)
        if (d.pump) {
            pumpSt.innerText = "ƒêANG B∆†M N∆Ø·ªöC"; pumpSt.style.color = "#2980b9";
            if(ROLE !== 'VIEWER') { document.getElementById('btnOn').style.display='none'; document.getElementById('btnOff').style.display='flex'; }
        } else {
            pumpSt.innerText = "B∆†M ƒêANG T·∫ÆT"; pumpSt.style.color = "#7f8c8d";
            if(ROLE !== 'VIEWER') { document.getElementById('btnOn').style.display='flex'; document.getElementById('btnOff').style.display='none'; }
        }

        // Logic Panel:
        if (ROLE === 'VIEWER') {
            // Kh√°ch: Lu√¥n hi·ªán Manual Panel (Disabled), ·∫®n AI
            pAuto.style.display = 'none';
            pManual.style.display = 'block';
        } else {
            // Admin: T√πy mode
            if (d.mode === 'AUTO') {
                pAuto.style.display = 'block';
                pManual.style.display = 'none'; // ·∫®n n√∫t b∆°m
                document.getElementById('aiTime').innerText = d.ai_timing || "...";
                document.getElementById('aiReason').innerText = d.ai_reason || "H·ªá th·ªëng ·ªïn ƒë·ªãnh";
            } else {
                pAuto.style.display = 'none';
                pManual.style.display = 'block'; // Hi·ªán n√∫t b∆°m
            }
        }

        // Chart
        if (myChart.data.labels.length > 15) { myChart.data.labels.shift(); myChart.data.datasets[0].data.shift(); }
        myChart.data.labels.push(""); myChart.data.datasets[0].data.push(d.soil);
        myChart.update();
    }

    // --- ACTIONS ---
    function emit(ev, d) { if(ROLE==='VIEWER') return; client.publish(PREFIX + 'events', JSON.stringify({event: ev, data: d})); }
    function pump(st) { emit('user_control', {pump: st}); }
    function exit() { if(confirm("V·ªÅ menu ch·ªçn ch·∫ø ƒë·ªô?")) emit('exit_dashboard', {}); }

    // Popup City
    const CITIES = ["H√† N·ªôi", "H·∫£i Ph√≤ng", "ƒê√† N·∫µng", "Hu·∫ø", "TP.HCM", "C·∫ßn Th∆°"];
    function openCityPopup() {
        if(ROLE==='VIEWER') return;
        const list = document.getElementById('cityList'); list.innerHTML = "";
        CITIES.forEach(c => {
            let b = document.createElement('button'); b.className = "btn-mini"; b.innerText = c; b.style.padding="10px";
            b.onclick = () => { emit('set_city', {city: c}); document.getElementById('cityPopup').style.display='none'; };
            list.appendChild(b);
        });
        document.getElementById('cityPopup').style.display = 'flex';
    }

    // History
    function openHistory() { document.getElementById('historyPopup').style.display = 'flex'; document.getElementById('dateInput').valueAsDate = new Date(); loadHistory(); }
    function loadHistory() {
        const d = document.getElementById('dateInput').value;
        fetch('/api/history?date=' + d).then(r=>r.json()).then(data => {
            const tb = document.getElementById('histBody'); tb.innerHTML = "";
            if(!data || !data.length) { tb.innerHTML = "<tr><td colspan='3' style='text-align:center'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>"; return; }
            data.forEach(i => {
                let color = i.action.includes('ON') ? 'green' : (i.action.includes('OFF')?'red':'blue');
                tb.innerHTML += `<tr><td style="color:#666">${i.time}</td><td style="color:${color};font-weight:bold">${i.action}</td><td>${i.detail}</td></tr>`;
            });
        });
    }
</script>
</body>
</html>
