<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Garden Pro</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary:#2e7d32; --bg-app:#e8f5e9; --danger:#d32f2f; }
        body { margin:0; font-family:'Be Vietnam Pro', sans-serif; background:var(--bg-app); color:#333; display:flex; justify-content:center; }
        .screen { position:fixed; width:100%; height:100%; background:#e8f5e9; z-index:99; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        #mainApp { width:100%; max-width:480px; padding:15px; box-sizing:border-box; display:none; }
        .card { background:white; border-radius:20px; padding:20px; box-shadow:0 5px 20px rgba(0,0,0,0.05); margin-bottom:15px; position:relative; }
        .btn-big { width:100%; max-width:300px; padding:15px; margin:10px; border:none; border-radius:12px; background:white; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.1); cursor:pointer; transition:0.2s; }
        .btn-big:active { transform:scale(0.95); }
        
        .soil-circle { width:150px; height:150px; border-radius:50%; border:10px solid #f1f8e9; margin:0 auto; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.5s; }
        .soil-val { font-size:40px; font-weight:800; color:var(--primary); }
        
        /* N√∫t B√∫t Ch·ªânh S·ª≠a */
        .edit-icon { cursor:pointer; opacity:0.6; transition:0.3s; margin-left:8px; font-size:18px; color:var(--primary); }
        .edit-icon:hover { opacity:1; transform:scale(1.2); }

        .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:20px; }
        .sensor-box { background:#f9fbe7; padding:10px; border-radius:12px; text-align:center; font-size:12px; }
        
        /* B·∫£ng L·ªãch s·ª≠ */
        .history-table { width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
        .history-table th { text-align:left; color:#777; padding:8px; border-bottom:1px solid #eee; }
        .history-table td { padding:8px; border-bottom:1px solid #f5f5f5; }
        
        .btn-pump { width:100%; padding:15px; border-radius:12px; border:none; color:white; font-weight:bold; cursor:pointer; margin-top:15px; font-size:16px; }

        /* Popup Ch·ªçn Th√†nh Ph·ªë */
        .popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:200; align-items:center; justify-content:center; backdrop-filter:blur(2px); }
        .popup-box { background:white; width:85%; max-width:350px; border-radius:20px; padding:20px; max-height:80vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        .city-item { padding:12px; border-bottom:1px solid #eee; cursor:pointer; font-weight:500; display:flex; align-items:center; }
        .city-item:hover { background:#f1f8e9; color:var(--primary); }
    </style>
</head>
<body>

<div id="screenRegion" class="screen">
    <h2 style="color:var(--primary)">üåç V√πng C·ªßa B·∫°n</h2>
    <button class="btn-big" onclick="selectRegion('NORTH')">Mi·ªÅn B·∫Øc</button>
    <button class="btn-big" onclick="selectRegion('CENTRAL')">Mi·ªÅn Trung</button>
    <button class="btn-big" onclick="selectRegion('SOUTH')">Mi·ªÅn Nam</button>
</div>

<div id="screenMode" class="screen" style="display:none">
    <h2 style="color:#673ab7">‚öôÔ∏è Ch·ªçn Ch·∫ø ƒê·ªô</h2>
    <button class="btn-big" style="color:#673ab7; border:2px solid #673ab7" onclick="enterMode('AUTO')">ü§ñ T·ª∞ ƒê·ªòNG (AI)</button>
    <button class="btn-big" onclick="enterMode('MANUAL')">üéÆ TH·ª¶ C√îNG</button>
    <div style="margin-top:20px; font-size:12px; color:#777; cursor:pointer" onclick="backStep()">‚¨Ö Quay l·∫°i</div>
</div>

<div id="mainApp">
    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px">
            <b style="color:var(--primary); font-size:18px">üå± Smart Garden</b>
            <div>
                <span onclick="resetConfig()" style="font-size:12px; cursor:pointer; margin-right:10px">‚öôÔ∏è C√†i ƒë·∫∑t</span>
                <a href="/logout" style="color:var(--danger); text-decoration:none; font-size:12px">Tho√°t</a>
            </div>
        </div>
        
        <div style="text-align:center; margin-bottom:15px">
            <div style="font-weight:bold; font-size:16px; display:flex; justify-content:center; align-items:center;">
                üìç <span id="loc">ƒêang t√¨m v·ªã tr√≠...</span>
                <span class="edit-icon" onclick="openCityPopup()" title="S·ª≠a v·ªã tr√≠ th·ªß c√¥ng">‚úèÔ∏è</span>
            </div>
            <div style="font-size:12px; color:#777; margin-top:4px" id="modeLabel">--</div>
        </div>

        <div class="soil-circle" id="soilBox">
            <span class="soil-val" id="soil">--</span>
            <span style="font-size:10px; color:#666">% ƒê·ªò ·∫®M</span>
        </div>
        
        <div style="text-align:center; margin-top:10px; font-weight:bold; color:#555" id="pumpSt">--</div>
        <div style="text-align:center; color:var(--danger); font-weight:bold; height:20px" id="warn"></div>

        <div class="grid-3">
            <div class="sensor-box"><b id="temp" style="font-size:16px">--</b><br>Nhi·ªát ƒë·ªô</div>
            <div class="sensor-box"><b id="hum" style="font-size:16px">--</b><br>Kh√¥ng kh√≠</div>
            <div class="sensor-box"><b id="rain" style="font-size:16px">--</b><br>M∆∞a</div>
        </div>

        <div id="panelAuto" style="display:none; background:#ede7f6; padding:15px; border-radius:12px; margin-top:15px; font-size:13px; line-height:1.5">
            <b style="color:#673ab7">ü§ñ AI GEMINI:</b> M·ª•c ti√™u gi·ªØ ƒë·∫•t ·∫©m <b id="aiTarget">--%</b>.<br>
            <span style="color:#555">üí¨ <i id="aiReason">...</i></span>
        </div>
        
        <div id="panelManual" style="display:none">
            <button id="btnOn" class="btn-pump" style="background:#2e7d32" onclick="pump(true)">B·∫¨T B∆†M üíß</button>
            <button id="btnOff" class="btn-pump" style="background:#c62828; display:none" onclick="pump(false)">T·∫ÆT B∆†M ‚õî</button>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <b>üìú Nh·∫≠t K√Ω Ho·∫°t ƒê·ªông</b>
            <button onclick="loadHistory()" style="font-size:18px; padding:0 10px; border:none; background:none; cursor:pointer">üîÑ</button>
        </div>
        <table class="history-table">
            <thead><tr><th>Gi·ªù</th><th>ƒê·ªô ·∫©m</th><th>H√†nh ƒë·ªông</th></tr></thead>
            <tbody id="histBody"><tr><td colspan="3" style="text-align:center; color:#999">ƒêang t·∫£i...</td></tr></tbody>
        </table>
    </div>
</div>

<div id="cityPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-box">
        <h3 style="color:var(--primary); margin-top:0">Ch·ªçn V·ªã Tr√≠ Th·ªß C√¥ng</h3>
        <p style="font-size:12px; color:#666">S·ª≠ d·ª•ng khi GPS ƒë·ªãnh v·ªã sai:</p>
        <div id="cityList"></div>
        <button onclick="document.getElementById('cityPopup').style.display='none'" style="width:100%; margin-top:15px; padding:12px; border:none; background:#eee; border-radius:8px; font-weight:bold">ƒê√≥ng</button>
    </div>
</div>

<script>
    const CLIENT_ID = 'web_' + Math.random().toString(16).substr(2, 8);
    const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt', { clientId: CLIENT_ID });
    const PREFIX = "thaocute_smartgarden/";
    
    // DANH S√ÅCH TH√ÄNH PH·ªê
    const CITIES = {
        'NORTH': ["H√† N·ªôi", "H·∫£i Ph√≤ng", "Qu·∫£ng Ninh", "L√†o Cai", "S∆°n La", "Nam ƒê·ªãnh", "Th√°i Nguy√™n"],
        'CENTRAL': ["ƒê√† N·∫µng", "Hu·∫ø", "Nha Trang", "Thanh H√≥a", "Vinh", "Quy Nh∆°n", "Qu·∫£ng B√¨nh"],
        'SOUTH': ["TP.HCM", "C·∫ßn Th∆°", "ƒê·ªìng Nai", "V≈©ng T√†u", "B√¨nh D∆∞∆°ng", "C√† Mau", "Ki√™n Giang"]
    };
    let currentRegion = 'NORTH';

    // UI LOGIC
    function showStep(s) {
        document.getElementById('screenRegion').style.display = s===0 ? 'flex':'none';
        document.getElementById('screenMode').style.display = s===1 ? 'flex':'none';
        document.getElementById('mainApp').style.display = s===2 ? 'block':'none';
        if(s===2) loadHistory();
    }
    showStep(0);

    // MQTT LOGIC
    client.on('connect', () => { 
        console.log("Connected MQTT");
        client.subscribe(PREFIX + 'update'); 
        // V·ª´a v√†o: 1. L·∫•y tr·∫°ng th√°i, 2. B·∫Øt bu·ªôc ƒë·ªãnh v·ªã l·∫°i ngay
        client.publish(PREFIX + 'events', JSON.stringify({event:'get_status'}));
        client.publish(PREFIX + 'events', JSON.stringify({event:'force_locate'}));
    });
    
    client.on('message', (t, m) => {
        const d = JSON.parse(m.toString());
        showStep(d.step);
        if(d.region) currentRegion = d.region;

        // C·∫≠p nh·∫≠t giao di·ªán
        document.getElementById('loc').innerText = d.location;
        document.getElementById('soil').innerText = d.soil;
        document.getElementById('temp').innerText = d.temp + "¬∞C";
        document.getElementById('hum').innerText = d.humidity + "%";
        document.getElementById('rain').innerText = d.rain;
        document.getElementById('warn').innerText = d.warning;
        document.getElementById('modeLabel').innerText = d.mode==='AUTO' ? "AUTO (AI T·ª∞ ƒê·ªòNG)" : "ƒêI·ªÄU KHI·ªÇN TH·ª¶ C√îNG";
        
        // M√†u s·∫Øc c·∫£nh b√°o
        document.getElementById('soilBox').style.borderColor = d.soil < 30 ? "#d32f2f" : "#2e7d32";
        const isPump = d.pump;
        document.getElementById('pumpSt').innerText = isPump ? "üí¶ M√ÅY B∆†M ƒêANG CH·∫†Y..." : "M√ÅY B∆†M T·∫ÆT";
        document.getElementById('pumpSt').style.color = isPump ? "#2196f3" : "#555";
        
        // Hi·ªán panel theo ch·∫ø ƒë·ªô
        if(d.mode === 'MANUAL') {
            document.getElementById('panelManual').style.display='block';
            document.getElementById('panelAuto').style.display='none';
            document.getElementById('btnOn').style.display = isPump ? 'none' : 'block';
            document.getElementById('btnOff').style.display = isPump ? 'block' : 'none';
        } else {
            document.getElementById('panelManual').style.display='none';
            document.getElementById('panelAuto').style.display='block';
            document.getElementById('aiTarget').innerText = d.ai_target + "%";
            document.getElementById('aiReason').innerText = d.ai_reason;
        }
    });

    // ACTIONS
    function selectRegion(r) { client.publish(PREFIX+'events', JSON.stringify({event:'select_region', data:{region:r}})); }
    function enterMode(m) { client.publish(PREFIX+'events', JSON.stringify({event:'enter_mode', data:{mode:m}})); }
    function pump(s) { client.publish(PREFIX+'events', JSON.stringify({event:'user_control', data:{pump:s}})); }
    function backStep() { client.publish(PREFIX+'events', JSON.stringify({event:'exit_dashboard'})); }
    
    function resetConfig() {
        if(confirm("B·∫°n mu·ªën c√†i ƒë·∫∑t l·∫°i V√πng v√† Ch·∫ø ƒë·ªô?")) {
            client.publish(PREFIX+'events', JSON.stringify({event:'exit_dashboard'}));
        }
    }

    // POPUP CITY
    function openCityPopup() {
        const list = document.getElementById('cityList');
        list.innerHTML = "";
        const regionList = CITIES[currentRegion] || CITIES['NORTH'];
        regionList.forEach(city => {
            let div = document.createElement('div');
            div.className = "city-item";
            div.innerHTML = `üìç ${city}`;
            div.onclick = () => {
                client.publish(PREFIX+'events', JSON.stringify({event:'set_city', data:{city:city}}));
                document.getElementById('cityPopup').style.display = 'none';
            };
            list.appendChild(div);
        });
        document.getElementById('cityPopup').style.display = 'flex';
    }

    // HISTORY
    function loadHistory() {
        fetch('/api/history').then(r=>r.json()).then(data => {
            const tb = document.getElementById('histBody');
            tb.innerHTML = "";
            if(data.length === 0) { tb.innerHTML = "<tr><td colspan='3' style='text-align:center'>Ch∆∞a c√≥ nh·∫≠t k√Ω</td></tr>"; return; }
            data.forEach(Row => {
                let color = Row.action.includes('ON') ? 'green' : (Row.action.includes('OFF') ? 'red' : 'purple');
                let soilColor = Row.soil < 30 ? 'red' : 'green';
                tb.innerHTML += `<tr><td>${Row.time}</td><td style="font-weight:bold; color:${soilColor}">${Row.soil}%</td><td style="color:${color}; font-weight:600">${Row.action}</td></tr>`;
            });
        });
    }
    // T·ª± ƒë·ªông l√†m m·ªõi l·ªãch s·ª≠ m·ªói 10s
    setInterval(loadHistory, 10000);
</script>
</body>
</html>
