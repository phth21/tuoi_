<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Garden Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* CH·ªà D√ôNG 1 PH√îNG CH·ªÆ DUY NH·∫§T */
        body {
            font-family: "Segoe UI", "Roboto", Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Full Screen Overlay */
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* Container Ch√≠nh */
        #mainApp { display: none; width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box; }

        /* Card Style - G·ªçn g√†ng, s·∫°ch s·∫Ω */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-simple {
            background: #e4e6eb; border: none; padding: 8px 16px;
            border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;
            color: #050505; transition: 0.2s;
        }
        .btn-simple:hover { background: #d8dadf; }
        
        .location-title { font-size: 18px; font-weight: 700; color: #1c1e21; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; }

        /* V√≤ng tr√≤n ƒë·ªô ·∫©m - T√¢m ƒëi·ªÉm */
        .soil-wrapper { text-align: center; margin: 20px 0; }
        .soil-circle {
            width: 180px; height: 180px; margin: 0 auto;
            border-radius: 50%; border: 12px solid #e4e6eb;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: border-color 0.3s;
        }
        .soil-value { font-size: 48px; font-weight: 700; color: #2ecc71; }
        .soil-label { font-size: 14px; color: #65676b; }
        
        .pump-status { font-size: 16px; font-weight: 600; color: #65676b; margin-top: 10px; }
        .warning-text { color: #e74c3c; font-weight: bold; min-height: 20px; font-size: 14px; margin-top: 5px; }

        /* Grid c·∫£m bi·∫øn */
        .sensor-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px; }
        .sensor-box { background: #f7f8fa; padding: 15px; border-radius: 12px; text-align: center; }
        .sensor-val { font-size: 20px; font-weight: 700; color: #333; display: block; }
        .sensor-name { font-size: 13px; color: #65676b; }

        /* ƒêi·ªÅu khi·ªÉn */
        .control-area { margin-top: 20px; }
        .btn-pump { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .on { background: #2ecc71; }
        .off { background: #e74c3c; }

        .ai-box { background: #e8f5e9; padding: 15px; border-radius: 12px; border-left: 5px solid #2ecc71; }
        .ai-time { font-weight: bold; color: #d35400; }

        /* Popup */
        .popup { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; }
        .popup-inner { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        
        /* Table L·ªãch s·ª≠ */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; color: #65676b; padding: 8px; border-bottom: 1px solid #eee; }
        td { padding: 8px; border-bottom: 1px solid #eee; }

        /* N√∫t to ·ªü m√†n h√¨nh start */
        .btn-big { padding: 20px 40px; font-size: 18px; border: none; border-radius: 12px; background: #2ecc71; color: white; cursor: pointer; margin: 10px; width: 200px; }
        .btn-big:hover { opacity: 0.9; }
    </style>
</head>
<body>

<div id="screenRegion" class="screen">
    <h2 style="margin-bottom:30px">Ch·ªçn Khu V·ª±c</h2>
    <button class="btn-big" onclick="emit('select_region', {region:'NORTH'})">Mi·ªÅn B·∫Øc</button>
    <button class="btn-big" style="background:#3498db" onclick="emit('select_region', {region:'CENTRAL'})">Mi·ªÅn Trung</button>
    <button class="btn-big" style="background:#e67e22" onclick="emit('select_region', {region:'SOUTH'})">Mi·ªÅn Nam</button>
</div>

<div id="screenMode" class="screen" style="display:none">
    <h2 style="margin-bottom:30px">Ch·ªçn Ch·∫ø ƒê·ªô</h2>
    <button class="btn-big" onclick="emit('enter_mode', {mode:'AUTO'})">ü§ñ T·ª± ƒê·ªông (AI)</button>
    <button class="btn-big" style="background:#95a5a6" onclick="emit('enter_mode', {mode:'MANUAL'})">üéÆ Th·ªß C√¥ng</button>
</div>

<div id="mainApp">
    <div class="card">
        <div class="header-row">
            <div id="mqttStatus" class="status-dot"></div>
            <div>
                {% if role != 'VIEWER' %} <button class="btn-simple" onclick="exit()">Menu</button> {% endif %}
                <a href="/logout" class="btn-simple" style="color:red">Tho√°t</a>
            </div>
        </div>

        <div class="header-row">
            <div class="location-title">üìç <span id="loc">ƒêang t·∫£i...</span></div>
            {% if role != 'VIEWER' %}
            <div>
                <button class="btn-simple" onclick="getRealGPS()">üéØ ƒê·ªãnh v·ªã</button>
                <button class="btn-simple" onclick="openCityPopup()">Danh s√°ch</button>
            </div>
            {% endif %}
        </div>

        <div class="soil-wrapper">
            <div class="soil-circle" id="soilBox">
                <span class="soil-value" id="soil">--</span>
                <span class="soil-label">% ƒê·ªò ·∫®M ƒê·∫§T</span>
            </div>
            <div class="warning-text" id="warn"></div>
            <div class="pump-status" id="pumpSt">M√ÅY B∆†M T·∫ÆT</div>
        </div>

        <div class="sensor-row">
            <div class="sensor-box">
                <span class="sensor-val" id="temp">--¬∞</span>
                <span class="sensor-name">Nhi·ªát ƒë·ªô</span>
            </div>
            <div class="sensor-box">
                <span class="sensor-val" id="hum">--%</span>
                <span class="sensor-name">ƒê·ªô ·∫©m KK</span>
            </div>
            <div class="sensor-box">
                <span class="sensor-val" id="rain">--</span>
                <span class="sensor-name">M∆∞a</span>
            </div>
        </div>

        <div class="control-area">
            <div id="panelAuto" style="display:none">
                <div class="ai-box">
                    <h4 style="margin:0 0 5px 0; color:#27ae60">ü§ñ AI Gemini ƒëang ch·∫°y</h4>
                    <p style="margin:5px 0; font-size:14px">D·ª± ki·∫øn t∆∞·ªõi: <span class="ai-time" id="aiTime">...</span></p>
                    <p style="margin:0; font-style:italic; font-size:13px; color:#555">" <span id="aiReason">...</span> "</p>
                </div>
            </div>

            <div id="panelManual" style="display:none">
                <div class="{% if role == 'VIEWER' %}viewer-disabled{% endif %}">
                    <button id="btnPumpOn" class="btn-pump on" onclick="pump(true)">B·∫¨T B∆†M T∆Ø·ªöI</button>
                    <button id="btnPumpOff" class="btn-pump off" onclick="pump(false)" style="display:none">T·∫ÆT M√ÅY B∆†M</button>
                </div>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <canvas id="myChart" height="100"></canvas>
            <button class="btn-simple" style="width:100%; margin-top:15px; background:#f0f2f5" onclick="openHistory()">Xem L·ªãch s·ª≠ ho·∫°t ƒë·ªông</button>
        </div>
    </div>
</div>

<div id="cityPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-inner">
        <h3>Ch·ªçn Th√†nh Ph·ªë</h3>
        <div id="cityList" style="display:grid; gap:10px;"></div>
        <button class="btn-simple" style="width:100%; margin-top:15px" onclick="document.getElementById('cityPopup').style.display='none'">ƒê√≥ng</button>
    </div>
</div>

<div id="historyPopup" class="popup" onclick="if(event.target==this) this.style.display='none'">
    <div class="popup-inner" style="max-width:600px">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px">
            <h3>Nh·∫≠t K√Ω</h3>
            <input type="date" id="dateInput" onchange="loadHistory()" style="padding:5px; border:1px solid #ddd; border-radius:5px">
        </div>
        <div style="overflow-x:auto">
            <table>
                <thead><tr><th>Gi·ªù</th><th>H√†nh ƒë·ªông</th><th>Chi ti·∫øt</th></tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
        <button class="btn-simple" style="width:100%; margin-top:15px" onclick="document.getElementById('historyPopup').style.display='none'">ƒê√≥ng</button>
    </div>
</div>

<script>
    const BROKER_URL = 'wss://broker.hivemq.com:8884/mqtt';
    const PREFIX = "thaocute_smartgarden/";
    const USER_ROLE = "{{ role }}"; 
    
    // MQTT Client setup
    const client = mqtt.connect(BROKER_URL, { keepalive: 60, clientId: 'Web_' + Math.random().toString(16).substr(2, 8), clean: true });
    
    // Chart setup
    let myChart = new Chart(document.getElementById('myChart'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'ƒê·ªô ·∫©m ƒë·∫•t (%)', data: [], borderColor: '#2ecc71', borderWidth: 2, tension: 0.4, fill: false, pointRadius: 0 }] },
        options: { scales: { y: { beginAtZero: true, max: 100, display: false }, x: { display: false } }, plugins: { legend: { display: false } } }
    });

    const CITIES = {
        'NORTH': ["H√† N·ªôi", "H·∫£i Ph√≤ng", "L√†o Cai", "Qu·∫£ng Ninh"],
        'CENTRAL': ["ƒê√† N·∫µng", "Hu·∫ø", "Nha Trang", "Vinh"],
        'SOUTH': ["TP.HCM", "C·∫ßn Th∆°", "C√† Mau", "V≈©ng T√†u"]
    };
    let currentRegion = 'NORTH';

    client.on('connect', () => {
        console.log("Connected");
        document.getElementById('mqttStatus').style.background = "#2ecc71"; // Xanh l√°
        client.subscribe(PREFIX + 'update');
    });

    client.on('message', (topic, msg) => {
        if (topic === PREFIX + 'update') updateUI(JSON.parse(msg.toString()));
    });

    function updateUI(d) {
        if (!d) return;
        currentRegion = d.region;

        // X·ª≠ l√Ω chuy·ªÉn m√†n h√¨nh
        if (USER_ROLE !== 'VIEWER') {
            document.getElementById('screenRegion').style.display = (d.step === 0) ? 'flex' : 'none';
            document.getElementById('screenMode').style.display   = (d.step === 1) ? 'flex' : 'none';
            document.getElementById('mainApp').style.display      = (d.step === 2) ? 'block' : 'none';
        } else {
            document.getElementById('mainApp').style.display = 'block'; // Viewer xem lu√¥n
        }

        // C·∫≠p nh·∫≠t s·ªë li·ªáu
        document.getElementById('loc').innerText = d.location;
        document.getElementById('temp').innerText = d.temp + "¬∞";
        document.getElementById('hum').innerText = d.humidity + "%";
        document.getElementById('rain').innerText = d.rain;
        document.getElementById('soil').innerText = d.soil;
        document.getElementById('warn').innerText = d.warning;

        // ƒê·ªïi m√†u v√≤ng tr√≤n ƒë·∫•t
        const soilBox = document.getElementById('soilBox');
        if (parseInt(d.soil) < 26) { soilBox.style.borderColor = "#e74c3c"; } 
        else { soilBox.style.borderColor = "#2ecc71"; }

        // Tr·∫°ng th√°i b∆°m & N√∫t b·∫•m
        const pst = document.getElementById('pumpSt');
        if (d.pump) { 
            pst.innerText = "üí¶ ƒêANG B∆†M N∆Ø·ªöC..."; pst.style.color = "#2980b9";
            document.getElementById('btnPumpOn').style.display = 'none';
            document.getElementById('btnPumpOff').style.display = 'flex';
        } else { 
            pst.innerText = "M√ÅY B∆†M T·∫ÆT"; pst.style.color = "#7f8c8d";
            document.getElementById('btnPumpOn').style.display = 'flex';
            document.getElementById('btnPumpOff').style.display = 'none';
        }

        document.getElementById('panelAuto').style.display = (d.mode === 'AUTO') ? 'block' : 'none';
        document.getElementById('panelManual').style.display = (d.mode === 'MANUAL') ? 'block' : 'none';
        
        if (d.mode === 'AUTO') {
            document.getElementById('aiTime').innerText = d.ai_timing;
            document.getElementById('aiReason').innerText = d.ai_reason;
        }

        // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì nh·∫π
        if (myChart.data.labels.length > 20) { myChart.data.labels.shift(); myChart.data.datasets[0].data.shift(); }
        myChart.data.labels.push(""); myChart.data.datasets[0].data.push(d.soil);
        myChart.update();
    }

    function emit(ev, d) { client.publish(PREFIX + 'events', JSON.stringify({event: ev, data: d})); }
    function pump(st) { emit('user_control', {pump: st}); }
    function exit() { if(confirm("V·ªÅ menu ch√≠nh?")) emit('exit_dashboard', {}); }

    function getRealGPS() {
        if (!navigator.geolocation) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£");
        document.getElementById('loc').innerText = "ƒêang ƒë·ªãnh v·ªã...";
        navigator.geolocation.getCurrentPosition(
            (p) => { emit('set_gps', { lat: p.coords.latitude, lon: p.coords.longitude }); },
            (e) => { alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠"); }
        );
    }

    function openCityPopup() {
        const list = document.getElementById('cityList'); list.innerHTML = "";
        (CITIES[currentRegion] || []).forEach(c => {
            let btn = document.createElement('button'); btn.className = "btn-simple"; btn.innerText = c;
            btn.onclick = () => { emit('set_city', {city: c}); document.getElementById('cityPopup').style.display='none'; };
            list.appendChild(btn);
        });
        document.getElementById('cityPopup').style.display = 'flex';
    }

    function openHistory() {
        document.getElementById('historyPopup').style.display = 'flex';
        document.getElementById('dateInput').valueAsDate = new Date();
        loadHistory();
    }

    function loadHistory() {
        fetch('/api/history?date=' + document.getElementById('dateInput').value)
            .then(res => res.json()).then(data => {
                const tbody = document.getElementById('histBody'); tbody.innerHTML = "";
                if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="3">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'; return; }
                data.forEach(i => {
                    let color = i.action.includes('ON') ? '#27ae60' : '#2980b9';
                    tbody.innerHTML += `<tr><td>${i.time}</td><td style="color:${color};font-weight:bold">${i.action}</td><td>${i.detail}</td></tr>`;
                });
            });
    }
</script>
</body>
</html>
